<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”Ÿæ­»è¨˜éŒ„å„€ V9.0 â€” VITAL LIFE MONITOR</title>
<link href="https://fonts.googleapis.com/css2?family=Jura:wght@400;600;700&family=Orbitron:wght@500;700;900&family=Share+Tech+Mono&family=Noto+Sans+TC:wght@300;400;700&family=Creepster&display=swap" rel="stylesheet">
<style>
:root {
    --c-bg: #030405;
    --c-panel: rgba(8, 12, 18, 0.95);
    --c-border: #1a2a3a;
    --c-accent: #00f3ff;
    --c-fatal: #ff2a2a;
    --c-crit: #ffae00;
    --c-acc: #00ff41;
    --c-dim: #3a4a5a;
    --c-soul: #a855f7;
    --f-mono: 'Share Tech Mono', monospace;
    --f-head: 'Orbitron', sans-serif;
    --f-text: 'Jura', 'Noto Sans TC', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
    height: 100%;
    overflow-x: hidden;
    background: var(--c-bg);
    color: #e0e6ed;
    font-family: var(--f-text);
}

/* ===== å…¨è¢å¹•ç²’å­èƒŒæ™¯ ===== */
#particle-bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 0;
    pointer-events: none;
}

/* ===== ç”Ÿæ­»å“²ç†é–‹å ´ ===== */
#philosophy-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(ellipse at center, rgba(5,0,10,0.98) 0%, rgba(0,0,0,1) 100%);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    transition: opacity 1.5s ease-out;
    cursor: pointer;
}
#philosophy-overlay.fade-out {
    opacity: 0;
    pointer-events: none;
}
.philosophy-text {
    font-family: var(--f-text);
    font-size: clamp(1.2rem, 4vw, 2.5rem);
    color: transparent;
    text-align: center;
    line-height: 2;
    max-width: 90%;
    animation: revealText 8s ease-out forwards;
}
.philosophy-text span {
    display: inline-block;
    background: linear-gradient(90deg, #ff2a2a, #ffae00, #00f3ff, #a855f7, #ff2a2a);
    background-size: 400% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    animation: gradientFlow 4s linear infinite;
}
@keyframes revealText {
    0% { opacity: 0; transform: translateY(30px); }
    20% { opacity: 1; transform: translateY(0); }
    80% { opacity: 1; }
    100% { opacity: 0.7; }
}
@keyframes gradientFlow {
    0% { background-position: 0% 50%; }
    100% { background-position: 400% 50%; }
}
.enter-hint {
    position: absolute;
    bottom: 15%;
    font-family: var(--f-mono);
    font-size: 14px;
    color: rgba(255,255,255,0.4);
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.8; }
}

/* ===== Header ===== */
header {
    position: relative;
    z-index: 10;
    background: linear-gradient(180deg, rgba(5,8,10,0.98) 0%, rgba(10,15,20,0.95) 100%);
    border-bottom: 2px solid var(--c-accent);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
}
.brand {
    font-family: var(--f-head);
    font-size: clamp(16px, 3vw, 24px);
    color: var(--c-accent);
    text-shadow: 0 0 20px rgba(0,243,255,0.6), 0 0 40px rgba(0,243,255,0.3);
    letter-spacing: 2px;
}
.brand-subtitle {
    color: #666;
    font-size: clamp(10px, 1.5vw, 13px);
    margin-left: 10px;
    font-family: var(--f-mono);
}

/* ===== ç”Ÿå‘½å¿ƒé›»åœ– ===== */
#ecg-container {
    width: clamp(120px, 20vw, 220px);
    height: 50px;
    background: rgba(0,0,0,0.7);
    border: 1px solid var(--c-fatal);
    border-radius: 6px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 0 20px rgba(255,42,42,0.3);
}
#ecg-canvas { width: 100%; height: 100%; }
.ecg-label {
    position: absolute;
    top: 4px;
    left: 8px;
    font-family: var(--f-mono);
    font-size: 9px;
    color: var(--c-fatal);
    opacity: 0.8;
}

/* ===== æ·±åˆ»å“²ç†å€ ===== */
.wisdom-banner {
    position: relative;
    z-index: 10;
    background: linear-gradient(90deg, rgba(20,0,30,0.9), rgba(40,0,20,0.9), rgba(20,0,30,0.9));
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid rgba(168,85,247,0.3);
}
.wisdom-quote {
    font-size: clamp(14px, 2.5vw, 20px);
    line-height: 1.8;
    color: #d4b8e8;
    font-style: italic;
    max-width: 900px;
    margin: 0 auto;
    text-shadow: 0 0 30px rgba(168,85,247,0.5);
}
.wisdom-source {
    margin-top: 10px;
    font-family: var(--f-mono);
    font-size: 12px;
    color: var(--c-soul);
}

/* ===== ç”Ÿæ­»ä¸€ç·šå€ ===== */
.lifeline-section {
    position: relative;
    z-index: 10;
    background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(20,5,10,0.95) 100%);
    padding: 30px 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}
.lifeline-card {
    background: rgba(10,10,20,0.8);
    border: 1px solid rgba(255,42,42,0.3);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.lifeline-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(from 0deg, transparent, rgba(255,42,42,0.1), transparent 30%);
    animation: cardRotate 8s linear infinite;
}
@keyframes cardRotate {
    100% { transform: rotate(360deg); }
}
.lifeline-card:hover {
    border-color: var(--c-fatal);
    box-shadow: 0 0 40px rgba(255,42,42,0.3);
    transform: translateY(-5px);
}
.lifeline-card h3 {
    font-family: var(--f-head);
    font-size: 14px;
    color: var(--c-fatal);
    margin-bottom: 15px;
    position: relative;
    z-index: 1;
}
.lifeline-card .big-number {
    font-family: var(--f-head);
    font-size: clamp(2rem, 6vw, 3.5rem);
    color: #fff;
    text-shadow: 0 0 30px currentColor;
    position: relative;
    z-index: 1;
}
.lifeline-card .unit {
    font-family: var(--f-mono);
    font-size: 14px;
    color: var(--c-crit);
    position: relative;
    z-index: 1;
}
.lifeline-card p {
    margin-top: 12px;
    font-size: 13px;
    color: #888;
    line-height: 1.6;
    position: relative;
    z-index: 1;
}

/* ===== ä»Šç”Ÿèˆ‡æ°¸æ†å°æ¯” ===== */
.eternity-contrast {
    position: relative;
    z-index: 10;
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 200px;
}
.eternity-side {
    padding: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    position: relative;
    overflow: hidden;
}
.eternity-side.mortal {
    background: linear-gradient(135deg, rgba(30,0,0,0.95), rgba(50,10,10,0.9));
    border-right: 2px solid rgba(255,42,42,0.5);
}
.eternity-side.eternal {
    background: linear-gradient(135deg, rgba(0,20,30,0.95), rgba(10,30,50,0.9));
}
.eternity-side h2 {
    font-family: 'Creepster', cursive;
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    margin-bottom: 15px;
}
.eternity-side.mortal h2 { color: var(--c-fatal); text-shadow: 0 0 30px rgba(255,42,42,0.7); }
.eternity-side.eternal h2 { color: var(--c-accent); text-shadow: 0 0 30px rgba(0,243,255,0.7); }
.eternity-side p {
    font-size: clamp(13px, 2vw, 16px);
    line-height: 1.8;
    max-width: 400px;
}
.eternity-side.mortal p { color: #ffaaaa; }
.eternity-side.eternal p { color: #aaffff; }
.divider-line {
    position: absolute;
    left: 50%;
    top: 0;
    height: 100%;
    width: 4px;
    background: linear-gradient(180deg, var(--c-fatal), var(--c-crit), var(--c-accent), var(--c-soul));
    animation: dividerPulse 3s ease-in-out infinite;
}
@keyframes dividerPulse {
    0%, 100% { opacity: 0.5; box-shadow: 0 0 20px currentColor; }
    50% { opacity: 1; box-shadow: 0 0 50px currentColor; }
}

/* ===== ç”¦é†’èˆ‡æ˜æ²‰ ===== */
.awakening-section {
    position: relative;
    z-index: 10;
    background: radial-gradient(ellipse at center, rgba(20,10,30,0.95) 0%, rgba(5,5,10,0.98) 100%);
    padding: 40px 20px;
    text-align: center;
}
.awakening-title {
    font-family: 'Creepster', cursive;
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    background: linear-gradient(90deg, var(--c-soul), var(--c-accent), var(--c-crit));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    margin-bottom: 30px;
}
.state-toggle {
    display: flex;
    justify-content: center;
    gap: 40px;
    flex-wrap: wrap;
}
.state-box {
    width: 200px;
    padding: 25px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.5s ease;
}
.state-box.asleep {
    background: rgba(50,20,20,0.8);
    border: 2px solid rgba(255,42,42,0.4);
}
.state-box.asleep:hover {
    background: rgba(80,20,20,0.9);
    box-shadow: 0 0 40px rgba(255,42,42,0.5);
}
.state-box.awake {
    background: rgba(20,40,50,0.8);
    border: 2px solid rgba(0,243,255,0.4);
}
.state-box.awake:hover {
    background: rgba(20,60,80,0.9);
    box-shadow: 0 0 40px rgba(0,243,255,0.5);
}
.state-box .icon {
    font-size: 3rem;
    margin-bottom: 10px;
}
.state-box h4 {
    font-family: var(--f-head);
    font-size: 16px;
    margin-bottom: 10px;
}
.state-box.asleep h4 { color: var(--c-fatal); }
.state-box.awake h4 { color: var(--c-accent); }
.state-box p {
    font-size: 12px;
    color: #888;
    line-height: 1.6;
}

/* ===== Main Layout ===== */
main {
    position: relative;
    z-index: 10;
    display: grid;
    grid-template-columns: 340px 1fr 360px;
    gap: 10px;
    padding: 10px;
    min-height: 600px;
}
.panel {
    background: var(--c-panel);
    border: 1px solid var(--c-border);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    backdrop-filter: blur(10px);
}
.p-head {
    background: linear-gradient(90deg, rgba(0,0,0,0.6), rgba(10,20,30,0.6));
    padding: 12px 16px;
    border-bottom: 1px solid var(--c-border);
    font-family: var(--f-mono);
    font-size: 12px;
    color: var(--c-accent);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* ===== æœå°‹ + åŒé½¡éæ¿¾ ===== */
.filter-row {
    display: flex;
    gap: 8px;
    padding: 10px 12px;
    flex-wrap: wrap;
    background: rgba(0,0,0,0.3);
}
#search-input, #age-filter {
    flex: 1;
    min-width: 100px;
    padding: 10px 12px;
    background: rgba(0,0,0,0.6);
    border: 1px solid var(--c-border);
    color: #fff;
    font-family: var(--f-mono);
    font-size: 12px;
    border-radius: 4px;
    transition: all 0.3s ease;
}
#search-input:focus, #age-filter:focus {
    border-color: var(--c-accent);
    box-shadow: 0 0 15px rgba(0,243,255,0.3);
    outline: none;
}
#age-filter { max-width: 100px; }

/* Category filter dropdown */
#category-filter {
    flex: 1;
    min-width: 120px;
    max-width: 180px;
    padding: 10px 12px;
    background: rgba(0,0,0,0.6);
    border: 1px solid var(--c-border);
    color: #fff;
    font-family: var(--f-mono);
    font-size: 12px;
    border-radius: 4px;
    transition: all 0.3s ease;
    cursor: pointer;
}

#category-filter:focus {
    border-color: var(--c-accent);
    box-shadow: 0 0 15px rgba(0,243,255,0.3);
    outline: none;
}

#category-filter option {
    background: #000;
    color: #fff;
}

/* Category badges */
.category-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: bold;
    margin-left: 8px;
    text-transform: uppercase;
}

/* Pagination controls */
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: rgba(0,0,0,0.3);
    border-top: 1px solid var(--c-border);
}

.pagination-controls button {
    padding: 8px 16px;
    background: rgba(0,0,0,0.6);
    border: 1px solid var(--c-border);
    color: var(--c-accent);
    font-family: var(--f-mono);
    font-size: 11px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.pagination-controls button:hover:not(:disabled) {
    border-color: var(--c-accent);
    background: rgba(0,243,255,0.1);
}

.pagination-controls button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.pagination-info {
    font-family: var(--f-mono);
    font-size: 11px;
    color: var(--c-dim);
}

/* ===== Log Stream ===== */
#log-stream {
    flex: 1;
    overflow-y: auto;
    max-height: 500px;
}
#log-stream::-webkit-scrollbar { width: 6px; }
#log-stream::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
#log-stream::-webkit-scrollbar-thumb { background: var(--c-dim); border-radius: 3px; }
.log-item {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(30,40,50,0.5);
    border-left: 4px solid transparent;
    position: relative;
    transition: all 0.3s ease;
    background: transparent;
}
.log-item:hover {
    background: rgba(255,255,255,0.03);
    transform: translateX(3px);
}
.log-item .date {
    color: #5a6a7a;
    font-size: 11px;
    font-family: var(--f-mono);
    display: block;
    margin-bottom: 4px;
}
.log-item .age-badge {
    background: linear-gradient(90deg, rgba(255,174,0,0.3), rgba(255,42,42,0.3));
    color: var(--c-crit);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    margin-left: 8px;
    font-family: var(--f-mono);
}
.log-item .title { font-size: 14px; line-height: 1.5; }
.log-item .title a {
    color: var(--c-accent);
    text-decoration: none;
    transition: all 0.2s ease;
}
.log-item .title a:hover { color: #fff; text-shadow: 0 0 10px var(--c-accent); }
.type-FATAL { border-left-color: var(--c-fatal); background: rgba(255,42,42,0.05); }
.type-FATAL .title a { color: #ffcccc; }
.type-CRIT { border-left-color: var(--c-crit); background: rgba(255,174,0,0.05); }
.type-CRIT .title a { color: #ffeebb; }
.type-ACC { border-left-color: var(--c-acc); background: rgba(0,255,65,0.03); }
.type-ACC .title a { color: #ccffcc; }

/* ===== ç‡­å…‰ ===== */
.candle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    cursor: pointer;
    opacity: 0.4;
    transition: all 0.3s ease;
    filter: grayscale(0.8);
}
.candle:hover {
    opacity: 0.8;
    filter: grayscale(0);
    transform: translateY(-50%) scale(1.2);
}
.candle.lit {
    opacity: 1;
    filter: grayscale(0);
    animation: candleFlicker 1.5s ease-in-out infinite;
}
@keyframes candleFlicker {
    0%, 100% {
        transform: translateY(-50%) scale(1);
        text-shadow: 0 0 20px #ff6600, 0 0 40px #ff3300;
    }
    25% {
        transform: translateY(-52%) scale(1.05);
        text-shadow: 0 0 25px #ff8800, 0 0 50px #ff4400;
    }
    50% {
        transform: translateY(-48%) scale(0.98);
        text-shadow: 0 0 15px #ff5500, 0 0 30px #ff2200;
    }
    75% {
        transform: translateY(-51%) scale(1.02);
        text-shadow: 0 0 30px #ff7700, 0 0 60px #ff3300;
    }
}

/* ===== é»ç‡­çµ±è¨ˆ ===== */
#candle-count {
    text-align: center;
    padding: 12px;
    color: var(--c-crit);
    font-family: var(--f-mono);
    font-size: 13px;
    border-top: 1px solid var(--c-border);
    background: rgba(0,0,0,0.4);
}

/* ===== é›·é”å€ ===== */
.radar-zone {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 380px;
    background: radial-gradient(circle, rgba(0,243,255,0.03) 0%, transparent 70%);
    overflow: hidden;
}
#radar-canvas, #soul-canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
}
#soul-canvas { pointer-events: none; }

/* ===== ä¸­å¤®çµ±è¨ˆ ===== */
.big-stat {
    position: relative;
    z-index: 10;
    text-align: center;
    background: rgba(0,0,0,0.85);
    padding: 25px 40px;
    border-radius: 16px;
    border: 2px solid rgba(0,243,255,0.4);
    box-shadow: 0 0 50px rgba(0,243,255,0.2), inset 0 0 30px rgba(0,243,255,0.05);
}
.big-stat .val {
    font-family: var(--f-head);
    font-size: clamp(2.5rem, 8vw, 4rem);
    color: #fff;
    text-shadow: 0 0 40px var(--c-accent), 0 0 80px var(--c-accent);
}
.big-stat .label {
    font-family: var(--f-mono);
    color: var(--c-accent);
    font-size: 11px;
    letter-spacing: 3px;
    margin-top: 8px;
}
.big-stat .sub-label {
    font-size: 13px;
    color: #888;
    margin-top: 5px;
}

/* ===== çµ±è¨ˆå¡ç‰‡ ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    padding: 15px;
}
.stat-card {
    background: rgba(0,0,0,0.5);
    border: 1px solid var(--c-border);
    border-radius: 8px;
    padding: 15px 10px;
    text-align: center;
    transition: all 0.3s ease;
}
.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.stat-card .icon { font-size: 24px; margin-bottom: 8px; }
.stat-card .num {
    font-family: var(--f-head);
    font-size: clamp(1.2rem, 3vw, 1.8rem);
    color: #fff;
}
.stat-card .lbl {
    font-size: 10px;
    color: #888;
    text-transform: uppercase;
    margin-top: 5px;
    font-family: var(--f-mono);
}
.stat-card.fatal { border-color: var(--c-fatal); }
.stat-card.fatal .num { color: var(--c-fatal); text-shadow: 0 0 20px var(--c-fatal); }
.stat-card.crit { border-color: var(--c-crit); }
.stat-card.crit .num { color: var(--c-crit); text-shadow: 0 0 20px var(--c-crit); }
.stat-card.acc { border-color: var(--c-acc); }
.stat-card.acc .num { color: var(--c-acc); text-shadow: 0 0 20px var(--c-acc); }

/* ===== ä»Šæ—¥èšç„¦ ===== */
#today-focus {
    background: linear-gradient(135deg, rgba(50,10,20,0.8), rgba(20,5,10,0.9));
    border: 1px solid var(--c-fatal);
    padding: 20px;
    margin: 10px;
    border-radius: 10px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
#today-focus::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,42,42,0.1), transparent);
    animation: focusSweep 4s linear infinite;
}
@keyframes focusSweep {
    100% { left: 100%; }
}
#today-focus .focus-title {
    font-family: var(--f-head);
    color: var(--c-fatal);
    font-size: 13px;
    margin-bottom: 12px;
    position: relative;
}
#today-focus .focus-content {
    font-size: 15px;
    line-height: 1.7;
    color: #ffcccc;
    position: relative;
}
#today-focus .focus-date {
    font-family: var(--f-mono);
    color: #666;
    font-size: 11px;
    margin-top: 12px;
    position: relative;
}

/* ===== é—œéµè©é›² ===== */
#keyword-cloud {
    padding: 20px;
    min-height: 140px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    justify-content: center;
}
.keyword-tag {
    padding: 6px 14px;
    border-radius: 20px;
    font-family: var(--f-mono);
    font-size: 11px;
    background: rgba(255,42,42,0.15);
    color: #ffaaaa;
    border: 1px solid rgba(255,42,42,0.3);
    transition: all 0.3s ease;
    cursor: pointer;
}
.keyword-tag:hover {
    background: var(--c-fatal);
    color: #fff;
    transform: scale(1.1);
    box-shadow: 0 0 20px var(--c-fatal);
}

/* ===== ä¸ƒç½å¹´è¦†è“‹ ===== */
#tribulation-overlay {
    background: linear-gradient(180deg, rgba(15,0,10,0.95), rgba(30,5,15,0.9));
    border: 1px solid rgba(200,20,40,0.4);
    padding: 25px 20px;
    border-radius: 12px;
    text-align: center;
    margin: 10px;
}
.trib-title {
    font-family: 'Creepster', cursive;
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    color: var(--c-fatal);
    text-shadow: 0 0 30px var(--c-fatal);
    margin-bottom: 10px;
}
.trib-subtitle {
    color: #aa6666;
    font-size: 14px;
    margin-bottom: 15px;
}
.trib-years {
    font-family: var(--f-head);
    font-size: 1.5rem;
    color: var(--c-crit);
    text-shadow: 0 0 20px var(--c-crit);
    margin: 15px 0;
}
.trib-link {
    display: inline-block;
    color: var(--c-acc);
    text-decoration: none;
    padding: 12px 24px;
    border: 1px solid var(--c-acc);
    border-radius: 6px;
    font-family: var(--f-mono);
    font-size: 12px;
    transition: all 0.3s ease;
    margin: 15px 0;
}
.trib-link:hover {
    background: rgba(0,255,65,0.15);
    box-shadow: 0 0 30px rgba(0,255,65,0.4);
    transform: translateY(-2px);
}
.trib-verse {
    font-size: 13px;
    color: #cc8888;
    line-height: 1.7;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid rgba(255,42,42,0.2);
}
.trib-verse .ref { color: var(--c-fatal); font-family: var(--f-mono); font-size: 11px; }

/* ===== ç”Ÿå‘½è¨ˆç®—å™¨å€ ===== */
.life-section {
    position: relative;
    z-index: 10;
    background: linear-gradient(180deg, rgba(10,15,20,0.75), rgba(20,25,35,0.7));
    backdrop-filter: blur(5px);
    padding: 30px 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}
.life-card {
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(8px);
    border: 1px solid var(--c-border);
    border-radius: 12px;
    padding: 25px;
    text-align: center;
}
.life-card h3 {
    font-family: var(--f-head);
    font-size: 14px;
    color: var(--c-accent);
    margin-bottom: 20px;
}
.life-card input {
    width: 100px;
    padding: 12px;
    background: rgba(0,0,0,0.6);
    border: 1px solid var(--c-border);
    color: #fff;
    font-family: var(--f-mono);
    font-size: 18px;
    text-align: center;
    border-radius: 6px;
    margin: 0 10px;
}
.life-card input:focus {
    border-color: var(--c-accent);
    outline: none;
    box-shadow: 0 0 20px rgba(0,243,255,0.3);
}
.life-card .result {
    margin-top: 20px;
    font-family: var(--f-mono);
    font-size: 16px;
    color: var(--c-crit);
    line-height: 1.8;
}
.life-card .result strong {
    font-size: 1.5em;
    color: #fff;
}
/* 4æ ¼çµ±è¨ˆæ¨£å¼ */
.life-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 20px;
}
.life-stat-box {
    background: rgba(0,0,0,0.5);
    border: 1px solid rgba(0,243,255,0.3);
    border-radius: 8px;
    padding: 15px 10px;
    text-align: center;
}
.life-stat-box .stat-value {
    font-family: var(--f-head);
    font-size: clamp(18px, 3vw, 24px);
    color: var(--c-accent);
    font-weight: bold;
}
.life-stat-box .stat-label {
    font-size: 11px;
    color: #888;
    margin-top: 5px;
}
.btn {
    background: rgba(0,243,255,0.1);
    border: 1px solid var(--c-accent);
    color: var(--c-accent);
    padding: 10px 20px;
    font-family: var(--f-head);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 4px;
    margin-top: 15px;
}
.btn:hover {
    background: var(--c-accent);
    color: #000;
    box-shadow: 0 0 25px var(--c-accent);
}

/* ===== æ¯æ—¥ç¶“æ–‡ + æ¯æ—¥ä¸€å• ===== */
.daily-section {
    position: relative;
    z-index: 10;
    background: rgba(5,10,15,0.95);
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}
#daily-verse, #daily-question {
    background: rgba(20,10,30,0.8);
    border-left: 4px solid var(--c-soul);
    padding: 20px;
    font-size: 14px;
    line-height: 1.8;
    border-radius: 0 8px 8px 0;
}
#daily-verse {
    border-left-color: var(--c-fatal);
    background: rgba(30,10,15,0.8);
}
#daily-question {
    border-left-color: var(--c-accent);
    background: rgba(10,20,30,0.8);
}

/* ===== è²¼ä¸Šå€ ===== */
.paste-zone {
    position: relative;
    z-index: 10;
    background: rgba(10,15,20,0.95);
    padding: 20px;
    border-bottom: 1px solid var(--c-border);
}
.paste-area {
    width: 100%;
    height: 100px;
    background: rgba(0,0,0,0.6);
    color: #eee;
    border: 1px solid var(--c-border);
    font-family: var(--f-mono);
    font-size: 12px;
    padding: 12px;
    resize: vertical;
    border-radius: 6px;
}
.paste-area:focus {
    border-color: var(--c-accent);
    outline: none;
}
.paste-buttons {
    margin-top: 12px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* ===== è–ç¶“é€£çµå€ ===== */
.bible-links {
    position: relative;
    z-index: 10;
    background: linear-gradient(180deg, rgba(25,10,35,0.95), rgba(15,5,25,0.9));
    border-top: 1px solid rgba(168,85,247,0.3);
    padding: 25px 20px 80px 20px; /* åº•éƒ¨åŠ å¤§ padding é¿å…è¢«è·‘é¦¬ç‡ˆè¦†è“‹ */
}
.bible-links h3 {
    color: var(--c-soul);
    font-family: 'Creepster', cursive;
    text-align: center;
    font-size: 1.5rem;
    margin-bottom: 20px;
    text-shadow: 0 0 20px var(--c-soul);
}
.link-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
}
.link-card {
    background: rgba(0,0,0,0.5);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid rgba(168,85,247,0.2);
    transition: all 0.3s ease;
}
.link-card:hover {
    border-color: var(--c-soul);
    box-shadow: 0 0 20px rgba(168,85,247,0.3);
}
.link-card .link-title {
    color: var(--c-accent);
    font-size: 12px;
    margin-bottom: 8px;
    font-family: var(--f-mono);
}
.link-card a {
    color: #bb99dd;
    text-decoration: none;
    font-size: 12px;
    transition: color 0.2s;
}
.link-card a:hover { color: #fff; }

/* ===== å›ºå®šè·‘é¦¬ç‡ˆ ===== */
#doom-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 45px;
    background: linear-gradient(90deg, #180000, #300005, #180000);
    border-top: 3px solid var(--c-fatal);
    z-index: 9999;
    overflow: hidden;
    line-height: 45px;
}
#footer-text {
    display: inline-block;
    white-space: nowrap;
    padding-left: 100%;
    animation: marquee 150s linear infinite;
    color: #ff9999;
    font-family: var(--f-mono);
    font-size: 13px;
}
@keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}

/* ===== é»˜å“€æ¨¡å¼ ===== */
body.mourning-mode {
    filter: grayscale(0.6);
}
body.mourning-mode .candle.lit {
    filter: grayscale(0) !important;
}

/* ===== æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ ===== */
@media (max-width: 1024px) {
    main { grid-template-columns: 1fr; }
    .eternity-contrast { grid-template-columns: 1fr; }
    .eternity-side.mortal { border-right: none; border-bottom: 2px solid rgba(255,42,42,0.5); }
    .divider-line { display: none; }
}
@media (max-width: 768px) {
    body { padding-bottom: 55px; }
    header { flex-direction: column; text-align: center; gap: 15px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .philosophy-text { font-size: 1.2rem; padding: 20px; }
    .state-toggle { gap: 20px; }
    .state-box { width: 160px; padding: 20px; }
}
@media (max-width: 480px) {
    .lifeline-section { grid-template-columns: 1fr; }
    .life-section { grid-template-columns: 1fr; }
    .daily-section { grid-template-columns: 1fr; }
    .big-stat { padding: 20px; }
    .big-stat .val { font-size: 2rem; }
}

/* ===== æ­»äº¡åŒæ­¥è¨ˆæ•¸å™¨ ===== */
#death-counter {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 50px;
    background: linear-gradient(180deg, rgba(20,0,0,0.95), rgba(0,0,0,0.9));
    border-bottom: 1px solid rgba(139,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 25px;
    z-index: 10000;
    font-family: var(--f-mono);
    font-size: 12px;
}
.counter-item {
    display: flex;
    align-items: center;
    gap: 6px;
}
.counter-label { color: #666; }
.counter-value {
    color: #ff4444;
    font-size: 15px;
    min-width: 50px;
    text-shadow: 0 0 10px rgba(255,68,68,0.5);
}
.counter-since {
    color: #444;
    font-size: 10px;
}
.back-to-portal {
    color: var(--c-accent);
    text-decoration: none;
    font-size: 11px;
    padding: 5px 10px;
    border: 1px solid var(--c-accent);
    border-radius: 4px;
    transition: all 0.3s;
}
.back-to-portal:hover {
    background: var(--c-accent);
    color: #000;
}
@media (max-width: 768px) {
    #death-counter {
        flex-wrap: wrap;
        height: auto;
        padding: 8px;
        gap: 8px;
    }
    .counter-since { display: none; }
}
header { margin-top: 50px; }

/* Navigation Bar Styles */
.main-nav {
    background-color: #1a1a1a;
    border-bottom: 2px solid #333;
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-logo {
    font-size: 1.5rem;
    font-weight: bold;
    color: #fff;
    text-decoration: none;
    letter-spacing: 1px;
}

.nav-logo span {
    color: #e74c3c;
}

.nav-links {
    display: flex;
    gap: 20px;
    list-style: none;
    margin: 0;
    padding: 0;
}

.nav-links a {
    color: #ccc;
    text-decoration: none;
    font-size: 1rem;
    transition: color 0.3s ease;
    padding: 5px 10px;
    border-radius: 4px;
}

.nav-links a:hover, .nav-links a.active {
    color: #fff;
    background-color: #333;
}

@media (max-width: 768px) {
    .nav-container {
        flex-direction: column;
        gap: 10px;
    }
    .nav-links {
        gap: 10px;
        font-size: 0.9rem;
    }
}
</style>
</head>
<body>

<nav class="main-nav">
    <div class="nav-container">
        <a href="index.html" class="nav-logo">ç”Ÿæ­»ä¹‹é–“ <span>LIFE</span></a>
        <ul class="nav-links">
            <li><a href="index.html">é¦–é  Home</a></li>
            <li><a href="monitor.html" class="active">ç”Ÿæ­»è¨˜éŒ„å„€ Monitor</a></li>
            <li><a href="docs/mission-briefing.html">ä»»å‹™ç¸½è¦½ Missions</a></li>
        </ul>
    </div>
</nav>

<!-- ===== å…¨è¢å¹•ç²’å­èƒŒæ™¯ ===== -->
<canvas id="particle-bg"></canvas>

<!-- ===== å“²ç†é–‹å ´ ===== -->
<div id="philosophy-overlay">
    <div class="philosophy-text">
        <span>ç”Ÿæ­»åªåœ¨ä¸€ç·šä¹‹é–“</span><br>
        <span>ä»Šç”Ÿèˆ‡æ°¸æ†ï¼Œç”¦é†’èˆ‡æ˜æ²‰</span><br><br>
        <span style="font-size:0.7em;opacity:0.7;">ä¸€æ¯å°šå­˜ï¼Œè¬äº‹å¯æœŸ</span><br>
        <span style="font-size:0.7em;opacity:0.7;">ä¸€æ¯å·²æ–·ï¼Œè¬äº‹çš†ç©º</span>
    </div>
    <div class="enter-hint">[ é»æ“Šé€²å…¥ç”Ÿæ­»è¨˜éŒ„å„€ ]</div>
</div>

<!-- ===== æ­»äº¡åŒæ­¥è¨ˆæ•¸å™¨ ===== -->
<div id="death-counter">
    <div class="counter-item">
        <span class="counter-label">ä½ é€²å…¥å¾Œï¼Œå…¨çƒå·²æœ‰</span>
        <span class="counter-value" id="death-since-entry">0</span>
        <span class="counter-label">äººæ­»äº¡</span>
    </div>
    <div class="counter-item">
        <span class="counter-label">ä»Šæ—¥å…¨çƒç´„</span>
        <span class="counter-value" id="death-today">0</span>
        <span class="counter-label">äººé›¢ä¸–</span>
    </div>
    <div class="counter-since">ï¼ˆæ¯ç§’ç´„ 1.8 äººãƒ»WHO å…¨çƒæ­»äº¡ç‡ä¼°ç®—ï¼‰</div>
    <a href="index.html" class="back-to-portal">â† è¿”å›é–€æˆ¶</a>
</div>

<!-- ===== Header ===== -->
<header>
    <div>
        <div class="brand">VITAL LIFE MONITOR</div>
        <span class="brand-subtitle">ç”Ÿæ­»è¨˜éŒ„å„€ V9.0 | 2019 COVID â†’ 2028 END-TIME?</span>
    </div>
    <div id="ecg-container">
        <span class="ecg-label">VITAL SIGNS</span>
        <canvas id="ecg-canvas"></canvas>
    </div>
    <div id="period-display" style="color:var(--c-crit);font-family:var(--f-mono);padding:8px 16px;border:1px solid var(--c-crit);border-radius:4px;font-size:12px;">
        ç­‰å¾…æ•¸æ“šè¼‰å…¥...
    </div>
</header>

<!-- ===== æ·±åˆ»å“²ç†å€ ===== -->
<div class="wisdom-banner">
    <div class="wisdom-quote" id="wisdom-quote">
        ã€Œä½ å€‘è¦è¬¹æ…è¡Œäº‹ï¼Œä¸è¦åƒæ„šæ˜§äººï¼Œç•¶åƒæ™ºæ…§äººã€‚è¦æ„›æƒœå…‰é™°ï¼Œå› ç‚ºç¾ä»Šçš„ä¸–ä»£é‚ªæƒ¡ã€‚ã€
    </div>
    <div class="wisdom-source" id="wisdom-source">â€” ä»¥å¼—æ‰€æ›¸ 5:15-16</div>
</div>

<!-- ===== ç”Ÿæ­»ä¸€ç·šå€ ===== -->
<div class="lifeline-section">
    <div class="lifeline-card">
        <h3>â±ï¸ æœ«æ¬¡è™Ÿç­’å€’æ•¸</h3>
        <div class="big-number" id="countdown-days">---</div>
        <div class="unit">å¤©</div>
        <p id="countdown-detail">è·é›¢ 2027-10-01</p>
    </div>
    <div class="lifeline-card">
        <h3>ğŸ’€ ä½ å·²æ´»äº†</h3>
        <div class="big-number" id="days-lived">---</div>
        <div class="unit">å¤©</div>
        <p>æ¯ä¸€å¤©éƒ½æ˜¯æ©å…¸</p>
    </div>
    <div class="lifeline-card">
        <h3>â³ å‡è¨­é‚„å‰©</h3>
        <div class="big-number" id="days-left">---</div>
        <div class="unit">å¤©</div>
        <p>æ´»åˆ° 85 æ­²çš„è©±</p>
    </div>
    <div class="lifeline-card">
        <h3>ğŸ“Š ç”Ÿå‘½é€²åº¦</h3>
        <div class="big-number" id="life-progress">--%</div>
        <div class="unit">å·²æ¶ˆè€—</div>
        <p>æ™‚é–“ä¸ç­‰äºº</p>
    </div>
</div>

<!-- ===== ä»Šç”Ÿèˆ‡æ°¸æ†å°æ¯” ===== -->
<div class="eternity-contrast">
    <div class="eternity-side mortal">
        <h2>ä»Š ç”Ÿ</h2>
        <p>
            è‚‰é«”æœƒæœ½å£ï¼Œæ¦®è¯æœƒæ¶ˆé€<br>
            ä¸€åˆ‡çš„è¿½æ±‚ï¼Œè½‰çœ¼æˆç©º<br>
            ã€Œå‡¡æœ‰è¡€æ°£çš„ç›¡éƒ½å¦‚è‰<br>
            ä»–çš„ç¾å®¹éƒ½åƒé‡åœ°çš„èŠ±ã€
        </p>
    </div>
    <div class="divider-line"></div>
    <div class="eternity-side eternal">
        <h2>æ°¸ æ†</h2>
        <p>
            éˆé­‚æ˜¯æ°¸å­˜çš„<br>
            ä½ å°‡å¾€ä½•è™•å»ï¼Ÿ<br>
            ã€ŒæŒ‰è‘—å®šå‘½ï¼Œäººäººéƒ½æœ‰ä¸€æ­»<br>
            æ­»å¾Œä¸”æœ‰å¯©åˆ¤ã€
        </p>
    </div>
</div>

<!-- ===== ç”¦é†’èˆ‡æ˜æ²‰ ===== -->
<div class="awakening-section">
    <div class="awakening-title">ç”¦ é†’ èˆ‡ æ˜ æ²‰</div>
    <div class="state-toggle">
        <div class="state-box asleep" onclick="toggleMourningMode()">
            <div class="icon">ğŸŒ‘</div>
            <h4>æ˜ æ²‰</h4>
            <p>æœªæ›¾æ€ç´¢ä¾†è™•<br>ä¸å•æ­¸å‘ä½•æ–¹<br>æ—¥å¾©ä¸€æ—¥ï¼Œå¹´å¾©ä¸€å¹´</p>
        </div>
        <div class="state-box awake">
            <div class="icon">âœ§</div>
            <h4>ç”¦ é†’</h4>
            <p>çŸ¥é“ç”Ÿå‘½æœ‰é™<br>æ´»å‡ºæ¯å¤©çš„åƒ¹å€¼<br>ç‚ºæ°¸æ†é å‚™</p>
        </div>
    </div>
</div>

<!-- ===== æ¯æ—¥ç¶“æ–‡ + æ¯æ—¥ä¸€å• ===== -->
<div class="daily-section">
    <div id="daily-verse">ğŸ“– è¼‰å…¥ä¸­...</div>
    <div id="daily-question">ğŸ’­ è¼‰å…¥ä¸­...</div>
</div>

<!-- ===== ç”Ÿå‘½è¨ˆç®—å™¨å€ ===== -->
<div class="life-section">
    <div class="life-card">
        <h3>â³ ä½ çš„ç”Ÿå‘½è¨ˆç®—å™¨</h3>
        <div>
            ä½ çš„å¹´é½¡ï¼š<input type="number" id="user-age" value="30" min="1" max="120"> æ­²
        </div>
        <button class="btn" onclick="calculateLife()">è¨ˆ ç®—</button>
        <!-- 4æ ¼çµ±è¨ˆé¡¯ç¤º -->
        <div class="life-stats-grid">
            <div class="life-stat-box">
                <div class="stat-value" id="days-lived-box">10,950</div>
                <div class="stat-label">å·²æ´»å¤©æ•¸</div>
            </div>
            <div class="life-stat-box">
                <div class="stat-value" id="days-left-box" style="color: var(--c-acc);">20,075</div>
                <div class="stat-label">å‰©é¤˜å¤©æ•¸</div>
            </div>
            <div class="life-stat-box">
                <div class="stat-value" id="life-percent-box" style="color: var(--c-crit);">35.3%</div>
                <div class="stat-label">ç”Ÿå‘½å·²ç”¨</div>
            </div>
            <div class="life-stat-box">
                <div class="stat-value" id="to-2027-box" style="color: var(--c-fatal);">--</div>
                <div class="stat-label">å¹è§’ç¯€å·²é</div>
            </div>
        </div>
        <div class="result" id="life-result" style="font-size:13px;margin-top:10px;">è¼¸å…¥ä½ çš„å¹´é½¡ï¼Œè¨ˆç®—ç”Ÿå‘½é€²åº¦</div>
    </div>
    <div class="life-card">
        <h3>ğŸ” åŒé½¡éæ¿¾å™¨</h3>
        <div>
            æŸ¥çœ‹ï¼š<input type="number" id="peer-age" placeholder="å¹´é½¡" min="1" max="120"> Â± 5æ­²
        </div>
        <button class="btn" onclick="filterByAge()">é æ¿¾</button>
        <div class="result" id="peer-result">è¼¸å…¥å¹´é½¡ï¼ŒæŸ¥çœ‹åŒé½¡äººçš„è¨˜éŒ„</div>
    </div>
</div>

<!-- ===== è²¼ä¸Šå€ ===== -->
<div class="paste-zone">
    <textarea id="paste-input" class="paste-area" placeholder="æŠŠè³‡æ–™è²¼åœ¨é€™è£¡ï¼ˆæ—¥æœŸ TAB ç¶²å€ TAB æ¨™é¡Œï¼‰&#10;æˆ–ç­‰å¾…è‡ªå‹•è¼‰å…¥ data.txt"></textarea>
    <div class="paste-buttons">
        <button class="btn" onclick="loadPastedData()">ğŸ“¥ è¼‰å…¥è²¼ä¸Šå…§å®¹</button>
        <button class="btn" onclick="document.getElementById('file-input').click()">ğŸ“‚ é¸æ“‡æª”æ¡ˆ</button>
        <button class="btn" onclick="exportSnapshot()">ğŸ’¾ åŒ¯å‡º HTML</button>
        <button class="btn" onclick="toggleMourningMode()">ğŸ•¯ï¸ é»˜å“€æ¨¡å¼</button>
        <input type="file" id="file-input" accept=".txt,.tsv" style="display:none;" onchange="handleFile(event)">
    </div>
</div>

<!-- ===== Main Layout ===== -->
<main>
    <!-- å·¦å´ï¼šäº‹ä»¶æµ -->
    <div class="panel">
        <div class="p-head">
            <span>ğŸ“¡ INCOMING FEED</span>
            <span>ç”Ÿæ­»äº‹ä»¶æµ</span>
        </div>
        <div class="filter-row">
            <input type="text" id="search-input" placeholder="ğŸ” æœå°‹é—œéµå­—..." oninput="filterEvents()" aria-label="æœå°‹äº‹ä»¶">
            <select id="category-filter" onchange="filterEvents()" aria-label="é¸æ“‡åˆ†é¡">
                <option value="">æ‰€æœ‰åˆ†é¡</option>
                <option value="çŒæ­»">çŒæ­»</option>
                <option value="å¤©ç½">å¤©ç½</option>
                <option value="ç¶“æ¿Ÿ">ç¶“æ¿Ÿ</option>
                <option value="é†«è—¥">é†«è—¥</option>
                <option value="å·¥æ¥­æ„å¤–">å·¥æ¥­æ„å¤–</option>
                <option value="äº¤é€š">äº¤é€š</option>
                <option value="ç«è­¦">ç«è­¦</option>
                <option value="AIå®‰å…¨">AIå®‰å…¨</option>
                <option value="æ‚²åŠ‡">æ‚²åŠ‡</option>
                <option value="æ²»å®‰">æ²»å®‰</option>
                <option value="å®—æ•™æœ«ä¸–">å®—æ•™æœ«ä¸–</option>
                <option value="é›¢ä¸–">é›¢ä¸–</option>
            </select>
            <input type="number" id="age-filter" placeholder="å¹´é½¡" min="1" max="120" aria-label="éæ¿¾å¹´é½¡">
        </div>
        <div id="log-stream"></div>
        <div class="pagination-controls">
            <button onclick="changePage(-1)" id="prev-page" aria-label="ä¸Šä¸€é ">â—„ ä¸Šä¸€é </button>
            <span class="pagination-info">
                ç¬¬ <span id="current-page-num">1</span> / <span id="total-page-num">1</span> é 
            </span>
            <button onclick="changePage(1)" id="next-page" aria-label="ä¸‹ä¸€é ">ä¸‹ä¸€é  â–º</button>
        </div>
        <div id="candle-count">ğŸ•¯ï¸ å·²æœ‰ <span id="total-candles">0</span> äººé»ç‡­å“€æ‚¼</div>
    </div>

    <!-- ä¸­é–“ï¼šé›·é” + çµ±è¨ˆ -->
    <div class="panel">
        <div class="radar-zone">
            <canvas id="radar-canvas"></canvas>
            <canvas id="soul-canvas"></canvas>
            <div class="big-stat">
                <div class="val" id="total-count">0</div>
                <div class="label">TOTAL INCIDENTS</div>
                <div class="sub-label">ç¸½å€‹æ¡ˆæ•¸</div>
            </div>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card fatal">
                <div class="icon">â˜ ï¸</div>
                <div class="num" id="stat-fatal">0</div>
                <div class="lbl">FATAL çŒæ­»</div>
            </div>
            <div class="stat-card crit">
                <div class="icon">âš ï¸</div>
                <div class="num" id="stat-crit">0</div>
                <div class="lbl">CRITICAL å±æ®†</div>
            </div>
            <div class="stat-card acc">
                <div class="icon">ğŸ”¥</div>
                <div class="num" id="stat-acc">0</div>
                <div class="lbl">ACCIDENT æ„å¤–</div>
            </div>
            <div class="stat-card">
                <div class="icon">ğŸ“Š</div>
                <div class="num" id="stat-other">0</div>
                <div class="lbl">OTHER å…¶ä»–</div>
            </div>
        </div>

        <!-- ä»Šæ—¥èšç„¦ -->
        <div id="today-focus">
            <div class="focus-title">ğŸ“ ä»Šæ—¥èšç„¦ / TODAY'S FOCUS</div>
            <div class="focus-content">è¼‰å…¥è³‡æ–™å¾Œé¡¯ç¤º...</div>
            <div class="focus-date"></div>
        </div>
    </div>

    <!-- å³å´ï¼šé—œéµè©é›² + ä¸ƒç½å¹´ -->
    <div class="panel">
        <div class="p-head"><span>â˜ï¸ KEYWORD CLOUD</span><span>é—œéµè©é›²</span></div>
        <div id="keyword-cloud"></div>

        <!-- ä¸ƒç½å¹´è¦†è“‹ -->
        <div id="tribulation-overlay">
            <div class="trib-title">ä¸ƒ ç½ å¹´</div>
            <div class="trib-subtitle">ä¸–ç•Œç—›è‹¦æ¼¸å¢çš„ä¸ƒå¹´</div>
            <div class="trib-years">2019 â€” 2028</div>
            <a href="https://greattribulaton2028.github.io/-/" target="_blank" class="trib-link">
                GREAT TRIBULATION<br>COUNTDOWN â†’ CLICK
            </a>
            <div class="trib-verse">
                ã€Œæˆ‘åˆçœ‹è¦‹æ­»äº†çš„äººï¼Œç„¡è«–å¤§å°ï¼Œéƒ½ç«™åœ¨å¯¶åº§å‰ã€‚æ¡ˆå·å±•é–‹äº†ï¼Œä¸¦ä¸”å¦æœ‰ä¸€å·å±•é–‹ï¼Œå°±æ˜¯ç”Ÿå‘½å†Šã€‚æ­»äº†çš„äººï¼Œéƒ½æ†‘è‘—é€™äº›æ¡ˆå·æ‰€è¨˜è¼‰çš„ï¼Œç…§ä»–å€‘æ‰€è¡Œçš„å—å¯©åˆ¤ã€‚ã€
                <br><span class="ref">â€” å•Ÿç¤ºéŒ„ 20:12</span>
            </div>
        </div>
    </div>
</main>

<!-- ===== è–ç¶“é€£çµå€ ===== -->
<div class="bible-links">
    <h3>ã€Šè–ç¶“Â·å¤§ç½é›£Â·è³‡è¨Šã€‹</h3>
    <div class="link-grid">
        <div class="link-card">
            <div class="link-title">01 è³‡è¨Š</div>
            <a href="https://e.pcloud.link/publink/show?code=kZt8zaZd7iPCbuRK7mXuE6Lg4fjEJ933Sr7" target="_blank">pCloud é€£çµ â†’</a>
        </div>
        <div class="link-card">
            <div class="link-title">02 ç˜Ÿç–«ä¸­çš„é‚ªè¡“</div>
            <a href="https://e.pcloud.link/publink/show?code=kZU8zaZLBosh9pTrp8O7DGN7wlrDJlU3JDy" target="_blank">pCloud é€£çµ â†’</a>
        </div>
        <div class="link-card">
            <div class="link-title">03 ç¬¬å››æ¬¡å·¥æ¥­é©å‘½</div>
            <a href="https://e.pcloud.link/publink/show?code=kZN8zaZXgsGC7Chqaprdidpa07hMSrFWyGV" target="_blank">pCloud é€£çµ â†’</a>
        </div>
        <div class="link-card">
            <div class="link-title">04 è–ç¶“è³‡è¨Šï¼ˆå»£æ±è©±ï¼‰</div>
            <a href="https://e.pcloud.link/publink/show?code=kZG8zaZpg5DO5gtmuhmDUrC4tjRCpJ7QT8V" target="_blank">pCloud é€£çµ â†’</a>
        </div>
        <div class="link-card">
            <div class="link-title">05 è–ç¶“è³‡è¨Šï¼ˆæ™®é€šè©±ï¼‰</div>
            <a href="https://e.pcloud.link/publink/show?code=kZG8zaZpg5DO5gtmuhmDUrC4tjRCpJ7QT8V" target="_blank">pCloud é€£çµ â†’</a>
        </div>
    </div>
</div>

<!-- ===== å›ºå®šè·‘é¦¬ç‡ˆ ===== -->
<footer id="doom-footer">
    <div id="footer-text">
        â—ˆ ç”Ÿæ­»åªåœ¨ä¸€ç·šä¹‹é–“ï¼Œä¸€æ¯å°šå­˜è¬äº‹å¯æœŸï¼Œä¸€æ¯å·²æ–·è¬äº‹çš†ç©º
        â—ˆ å…¨çƒå¤§é‡ç½® 2017â†’2027â†’ç¬¬å››æ¬¡å·¥æ¥­é©å‘½â†’Great Resetâ†’é›»å­è²¨å¹£åŒ–
        â—ˆ You will own nothing but you will be happy â†’ ä½ å°‡ä¸€ç„¡æ‰€æœ‰ï¼Œä½†ä½ æœƒå¿«æ¨‚ï¼Ÿ
        â—ˆ (2019-2028) > ç˜Ÿç–« > æˆ°çˆ­ > ç¶“æ¿Ÿè¡°é€€ > æŒçºŒå¥åº·æƒ¡åŒ– > 2026-2028 æ›´åš´å³»
        â—ˆ COVID > DNAâ†’mRNAâ†’Nanopatchâ†’Luciferaseâ†’äººå·¥æ™¶ç‰‡â†’äººè‡ªé¡˜è¢«è½‰åŒ–æˆGMOâ†’å°ˆåˆ©ä¸‹çš„å•†å“
        â—ˆ ç¬¬40å€‹ç¦§å¹´ â†’ æœ«æ¬¡è™Ÿç­’ â†’ ä¸ƒå¹´å¤§ç½é›£ â†’ End...
        â—ˆ ã€Œå…¶å¯¦æ˜å¤©å¦‚ä½•ï¼Œä½ å€‘é‚„ä¸çŸ¥é“ã€‚ä½ å€‘çš„ç”Ÿå‘½æ˜¯ç”šéº¼å‘¢ï¼Ÿä½ å€‘åŸä¾†æ˜¯ä¸€ç‰‡é›²éœ§ï¼Œå‡ºç¾å°‘æ™‚å°±ä¸è¦‹äº†ã€‚ã€â€” é›…å„æ›¸ 4:14
        â—ˆ ä»Šç”Ÿèˆ‡æ°¸æ†ï¼Œç”¦é†’èˆ‡æ˜æ²‰ï¼Œä½ é¸æ“‡å“ªä¸€é‚Šï¼Ÿ
    </div>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç”Ÿæ­»è¨˜éŒ„å„€ V9.0 - æœ«ä¸–å²è©©ç‰ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// === å…¨åŸŸè®Šæ•¸ ===
let allEvents = [];
let filteredEvents = [];

// Pagination variables
let currentPage = 1;
let itemsPerPage = 50; // Default batch size
let itemsPerPage = 30; // Default batch size (reduced from 50 for better UX)
let totalPages = 1;
let candleCounts = JSON.parse(localStorage.getItem('candleCounts') || '{}');
let totalCandles = Object.values(candleCounts).reduce((a, b) => a + b, 0);
let userAge = 30;

// === æ¯æ—¥ç¶“æ–‡åº«ï¼ˆæ·±åˆ»ç‰ˆï¼‰===
const dailyVerses = [
    { text: "ç”Ÿæœ‰æ™‚ï¼Œæ­»æœ‰æ™‚ï¼›æ ½ç¨®æœ‰æ™‚ï¼Œæ‹”å‡ºæ‰€æ ½ç¨®çš„ä¹Ÿæœ‰æ™‚ã€‚", ref: "å‚³é“æ›¸ 3:2" },
    { text: "å…¶å¯¦æ˜å¤©å¦‚ä½•ï¼Œä½ å€‘é‚„ä¸çŸ¥é“ã€‚ä½ å€‘çš„ç”Ÿå‘½æ˜¯ç”šéº¼å‘¢ï¼Ÿä½ å€‘åŸä¾†æ˜¯ä¸€ç‰‡é›²éœ§ï¼Œå‡ºç¾å°‘æ™‚å°±ä¸è¦‹äº†ã€‚", ref: "é›…å„æ›¸ 4:14" },
    { text: "ä½ å€‘è¦è¬¹æ…è¡Œäº‹ï¼Œä¸è¦åƒæ„šæ˜§äººï¼Œç•¶åƒæ™ºæ…§äººã€‚è¦æ„›æƒœå…‰é™°ï¼Œå› ç‚ºç¾ä»Šçš„ä¸–ä»£é‚ªæƒ¡ã€‚", ref: "ä»¥å¼—æ‰€æ›¸ 5:15-16" },
    { text: "æŒ‰è‘—å®šå‘½ï¼Œäººäººéƒ½æœ‰ä¸€æ­»ï¼Œæ­»å¾Œä¸”æœ‰å¯©åˆ¤ã€‚", ref: "å¸Œä¼¯ä¾†æ›¸ 9:27" },
    { text: "æˆ‘å€‘ä¸€ç”Ÿçš„å¹´æ—¥æ˜¯ä¸ƒåæ­²ï¼Œè‹¥æ˜¯å¼·å£¯å¯åˆ°å…«åæ­²ï¼›ä½†å…¶ä¸­æ‰€çŸœèª‡çš„ä¸éæ˜¯å‹è‹¦æ„ç…©ï¼Œè½‰çœ¼æˆç©ºï¼Œæˆ‘å€‘ä¾¿å¦‚é£›è€Œå»ã€‚", ref: "è©©ç¯‡ 90:10" },
    { text: "å‡¡æœ‰è¡€æ°£çš„ç›¡éƒ½å¦‚è‰ï¼›ä»–çš„ç¾å®¹éƒ½åƒé‡åœ°çš„èŠ±ã€‚è‰å¿…æ¯ä¹¾ï¼ŒèŠ±å¿…å‡‹æ®˜ã€‚", ref: "ä»¥è³½äºæ›¸ 40:6-7" },
    { text: "ç¥æ„›ä¸–äººï¼Œç”šè‡³å°‡ä»–çš„ç¨ç”Ÿå­è³œçµ¦ä»–å€‘ï¼Œå«ä¸€åˆ‡ä¿¡ä»–çš„ï¼Œä¸è‡´æ»…äº¡ï¼Œåå¾—æ°¸ç”Ÿã€‚", ref: "ç´„ç¿°ç¦éŸ³ 3:16" },
    { text: "é‚£æ®ºèº«é«”ã€ä¸èƒ½æ®ºéˆé­‚çš„ï¼Œä¸è¦æ€•ä»–å€‘ï¼›æƒŸæœ‰èƒ½æŠŠèº«é«”å’Œéˆé­‚éƒ½æ»…åœ¨åœ°ç„è£¡çš„ï¼Œæ­£è¦æ€•ä»–ã€‚", ref: "é¦¬å¤ªç¦éŸ³ 10:28" },
    { text: "æˆ‘è½è¦‹å¾å¤©ä¸Šæœ‰è²éŸ³èªªï¼šä½ è¦å¯«ä¸‹ï¼šå¾ä»Šä»¥å¾Œï¼Œåœ¨ä¸»è£¡é¢è€Œæ­»çš„äººæœ‰ç¦äº†ï¼", ref: "å•Ÿç¤ºéŒ„ 14:13" },
    { text: "ä½ æ±‚å‘Šæˆ‘ï¼Œæˆ‘å°±æ‡‰å…ä½ ï¼Œä¸¦å°‡ä½ æ‰€ä¸çŸ¥é“ã€åˆå¤§åˆé›£çš„äº‹æŒ‡ç¤ºä½ ã€‚", ref: "è€¶åˆ©ç±³æ›¸ 33:3" },
    { text: "äººè‹¥è³ºå¾—å…¨ä¸–ç•Œï¼Œè³ ä¸Šè‡ªå·±çš„ç”Ÿå‘½ï¼Œæœ‰ç”šéº¼ç›Šè™•å‘¢ï¼Ÿäººé‚„èƒ½æ‹¿ç”šéº¼æ›ç”Ÿå‘½å‘¢ï¼Ÿ", ref: "é¦¬å¤ªç¦éŸ³ 16:26" },
    { text: "ä¸è¦ç‚ºé‚£å¿…å£çš„é£Ÿç‰©å‹åŠ›ï¼Œè¦ç‚ºé‚£å­˜åˆ°æ°¸ç”Ÿçš„é£Ÿç‰©å‹åŠ›ã€‚", ref: "ç´„ç¿°ç¦éŸ³ 6:27" }
];

// === æ¯æ—¥ä¸€å•åº«ï¼ˆæ·±åˆ»ç‰ˆï¼‰===
const dailyQuestions = [
    "ğŸ’­ å¦‚æœä»Šå¤©æ˜¯ä½ ç”Ÿå‘½çš„æœ€å¾Œä¸€å¤©ï¼Œä½ æœƒåšä»€éº¼ï¼Ÿæœ‰æ²’æœ‰æœªå®Œæˆçš„éºé¡˜ï¼Ÿ",
    "ğŸ’­ ä½ ä¸Šä¸€æ¬¡èªçœŸæ€è€ƒæ­»äº¡æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿé‚£æ¬¡æ€è€ƒæ”¹è®Šäº†ä½ ä»€éº¼ï¼Ÿ",
    "ğŸ’­ æœ‰æ²’æœ‰ä»€éº¼è©±ï¼Œä½ ä¸€ç›´æƒ³å°æŸäººèªªå»é‚„æ²’èªªå‡ºå£ï¼Ÿç‚ºä»€éº¼ä¸èªªï¼Ÿ",
    "ğŸ’­ ä½ è¦ºå¾—è‡ªå·±æ´»å¾—æœ‰æ„ç¾©å—ï¼Ÿå¦‚æœä¸æ˜¯ï¼Œä»€éº¼æ‰æ˜¯æœ‰æ„ç¾©çš„äººç”Ÿï¼Ÿ",
    "ğŸ’­ å¦‚æœå¯ä»¥çµ¦åå¹´å‰çš„è‡ªå·±ä¸€å€‹å¿ å‘Šï¼Œä½ æœƒèªªä»€éº¼ï¼Ÿ",
    "ğŸ’­ ä½ æœ€å®³æ€•çš„æ˜¯æ­»äº¡æœ¬èº«ï¼Œé‚„æ˜¯æ­»å‰çš„ç—›è‹¦ï¼Œé‚„æ˜¯æ­»å¾Œçš„æœªçŸ¥ï¼Ÿ",
    "ğŸ’­ æœ‰æ²’æœ‰äººå› ç‚ºä½ çš„å­˜åœ¨è€Œæ„Ÿåˆ°å¹¸ç¦ï¼Ÿä½ ç‚ºä»–å€‘åšéä»€éº¼ï¼Ÿ",
    "ğŸ’­ ä½ ç›¸ä¿¡æ­»å¾Œé‚„æœ‰ç”Ÿå‘½å—ï¼Ÿé€™å€‹ä¿¡å¿µå¦‚ä½•å½±éŸ¿ä½ ç¾åœ¨çš„ç”Ÿæ´»ï¼Ÿ",
    "ğŸ’­ ä½ æœ€æƒ³è¢«äººè¨˜ä½çš„æ˜¯ä»€éº¼ï¼Ÿç•¶äººå€‘æèµ·ä½ çš„åå­—æ™‚ï¼Œæœƒæƒ³èµ·ä»€éº¼ï¼Ÿ",
    "ğŸ’­ ä»Šå¤©ï¼Œä½ æ„Ÿæ©ä»€éº¼ï¼Ÿæœ‰æ²’æœ‰ä»€éº¼æ˜¯ä½ ä¸€ç›´å¿½ç•¥çš„æ©å…¸ï¼Ÿ",
    "ğŸ’­ å¦‚æœä½ åªå‰©ä¸‹ä¸€å¹´çš„ç”Ÿå‘½ï¼Œä½ æœƒå¦‚ä½•é‡æ–°å®‰æ’å„ªå…ˆæ¬¡åºï¼Ÿ",
    "ğŸ’­ ä½ æ˜¯åœ¨ã€Œæ´»è‘—ã€é‚„æ˜¯ã€Œç”Ÿå­˜ã€ï¼Ÿå…©è€…æœ‰ä»€éº¼åˆ†åˆ¥ï¼Ÿ"
];

// === æ™ºæ…§åè¨€åº« ===
const wisdomQuotes = [
    { text: "æœªçŸ¥ç”Ÿï¼Œç„‰çŸ¥æ­»ï¼Ÿ", source: "å­”å­" },
    { text: "äººç”Ÿè‡ªå¤èª°ç„¡æ­»ï¼Œç•™å–ä¸¹å¿ƒç…§æ±—é’ã€‚", source: "æ–‡å¤©ç¥¥" },
    { text: "æ­»äº¡ä¸æ˜¯ç”Ÿå‘½çš„çµ‚çµï¼Œéºå¿˜æ‰æ˜¯ã€‚", source: "é›»å½±ã€Šå°‹å¤¢ç’°éŠè¨˜ã€‹" },
    { text: "æ´»è‘—çš„æ™‚å€™è¦æƒ³åˆ°æ­»ï¼Œæ­»çš„æ™‚å€™è¦æƒ³åˆ°æ°¸ç”Ÿã€‚", source: "è–å¥§å¤æ–¯ä¸" },
    { text: "äººçµ‚ç©¶è¦æ­»ï¼Œä½†çœŸæ­£çš„å•é¡Œæ˜¯ï¼šä½ æ˜¯å¦çœŸçš„æ´»éï¼Ÿ", source: "å¨å»‰Â·è¯èŠå£«" },
    { text: "æ™‚é–“æ˜¯æœ€å…¬å¹³çš„ï¼Œæ¯å€‹äººæ¯å¤©éƒ½åªæœ‰24å°æ™‚ã€‚", source: "å¡å…§åŸº" },
    { text: "ç”Ÿå‘½ä¸åœ¨æ–¼é•·çŸ­ï¼Œè€Œåœ¨æ–¼æ·±åº¦ã€‚", source: "æ„›é»˜ç”Ÿ" }
];

// === 12 Category Configuration System ===
const categoryConfig = {
    'çŒæ­»': {
        name: 'çŒæ­»',
        keywords: ["çŒæ­»", "æš´æ–ƒ", "å¿ƒè‡Ÿé©Ÿåœ", "å¿ƒè‚Œæ¢—å¡", "è…¦æº¢è¡€", "å™¨å®˜è¡°ç«­", "çªç„¶æ­»äº¡", "ä¸æ²»"],
        color: '#ff2a2a',
        color: '#ff3333',  // Increased brightness for better contrast
        priority: 1
    },
    'å¤©ç½': {
        name: 'å¤©ç½',
        keywords: ["åœ°éœ‡", "æµ·å˜¯", "é¢±é¢¨", "é¢¶é¢¨", "æ´ªæ°´", "æ°´ç½", "æ—±ç½", "é›ªç½", "é¾æ²é¢¨", "å±±æ³¥å‚¾ç€‰", "åœŸçŸ³æµ"],
        color: '#8b4513',
        color: '#b36b2e',  // Increased brightness for better contrast
        priority: 2
    },
    'ç¶“æ¿Ÿ': {
        name: 'ç¶“æ¿Ÿ',
        keywords: ["ç ´ç”¢", "å€’é–‰", "è£å“¡", "å¤±æ¥­", "é‡‘èå±æ©Ÿ", "ç¶“æ¿Ÿè¡°é€€", "è‚¡ç½", "å‚µå‹™", "é€šè„¹"],
        color: '#ffae00',
        color: '#ffb820',  // Slightly brighter orange
        priority: 3
    },
    'é†«è—¥': {
        name: 'é†«è—¥',
        keywords: ["ç–«æƒ…", "ç—…æ¯’", "ç™Œç—‡", "ç–¾ç—…", "é†«ç™‚äº‹æ•…", "è—¥ç‰©", "å‚³æŸ“ç—…", "æµæ„Ÿ", "ç–«è‹—", "ç—…å±", "æ˜è¿·"],
        color: '#00ff41',
        color: '#00ff55',  // Slightly brighter green
        priority: 4
    },
    'å·¥æ¥­æ„å¤–': {
        name: 'å·¥æ¥­æ„å¤–',
        keywords: ["å·¥å‚·", "å·¥æ¥­æ„å¤–", "å·¥åœ°", "æ–½å·¥", "å¡Œé™·", "çˆ†ç‚¸", "åŒ–å­¸å“", "å·¥å» ", "è·æ¥­ç½å®³"],
        color: '#ff6600',
        color: '#ff7722',  // Brighter orange-red
        priority: 5
    },
    'äº¤é€š': {
        name: 'äº¤é€š',
        keywords: ["è»Šç¦", "äº¤é€šæ„å¤–", "æ’è»Š", "ç¿»è»Š", "å¤±æ§", "äº¤é€šäº‹æ•…", "é£›æ©Ÿ", "ç«è»Š", "èˆ¹é›£", "å¢®æµ·"],
        color: '#00f3ff',
        color: '#00f5ff',  // Slightly brighter cyan
        priority: 6
    },
    'ç«è­¦': {
        name: 'ç«è­¦',
        keywords: ["ç«è­¦", "ç«ç½", "å¤§ç«", "ç‡’å‚·", "çˆ†ç‚¸", "ç‡ƒç‡’", "ç«å ´", "æ¿ƒç…™"],
        color: '#ff4500',
        color: '#ff5522',  // Brighter orange-red
        priority: 7
    },
    'AIå®‰å…¨': {
        name: 'AIå®‰å…¨',
        keywords: ["äººå·¥æ™ºèƒ½", "AI", "æ©Ÿå™¨äºº", "è‡ªå‹•åŒ–", "ç®—æ³•", "æ•¸æ“šæ´©éœ²", "ç¶²çµ¡æ”»æ“Š", "é»‘å®¢", "ç§‘æŠ€äº‹æ•…"],
        color: '#9370db',
        color: '#a888ff',  // Increased brightness for purple
        priority: 8
    },
    'æ‚²åŠ‡': {
        name: 'æ‚²åŠ‡',
        keywords: ["è‡ªæ®º", "è¼•ç”Ÿ", "è·³æ¨“", "å¢®æ¨“", "ç‡’ç‚­", "å°‹æ­»", "è‡ªç›¡", "æ‚²åŠ‡"],
        color: '#4b0082',
        color: '#7722cc',  // Brighter deep purple
        priority: 9
    },
    'æ²»å®‰': {
        name: 'æ²»å®‰',
        keywords: ["è¬€æ®º", "å…‡æ®º", "è¥²æ“Š", "æ§æ“Š", "åˆ€å‚·", "æš´åŠ›", "æ¶åŠ«", "ç¶æ¶", "æè¥²", "ææ€–è¥²æ“Š"],
        color: '#dc143c',
        color: '#ff2244',  // Brighter crimson
        priority: 10
    },
    'å®—æ•™æœ«ä¸–': {
        name: 'å®—æ•™æœ«ä¸–',
        keywords: ["é è¨€", "æœ«ä¸–", "å•Ÿç¤ºéŒ„", "ç½é›£", "å¯©åˆ¤", "å¤©å•Ÿ", "çµ‚çµ", "æœ«æ—¥"],
        color: '#a855f7',
        color: '#bb66ff',  // Brighter purple
        priority: 11
    },
    'é›¢ä¸–': {
        name: 'é›¢ä¸–',
        keywords: ["é›¢ä¸–", "éèº«", "é€ä¸–", "æ­»äº¡", "èº«äº¡", "å»ä¸–", "å–ªç”Ÿ", "ç½¹é›£", "å®£å‘Šæ­»äº¡"],
        color: '#696969',
        color: '#888888',  // Brighter gray for better contrast
        priority: 12
    }
};

// === Legacy keyword arrays for backward compatibility ===
const fatalKeywords = ["çŒæ­»", "æ­»äº¡", "ä¸æ²»", "æš´æ–ƒ", "èº«äº¡", "æººæ–ƒ", "é›¢ä¸–", "éèº«", "å¿ƒè‡Ÿé©Ÿåœ", "å¿ƒè‚Œæ¢—å¡", "è…¦æº¢è¡€", "å™¨å®˜è¡°ç«­", "é€é™¢ä¸æ²»", "å®£å‘Šæ­»äº¡"];
const critKeywords = ["å±æ®†", "æ˜è¿·", "å‘½å±", "æ¶æ•‘", "é‡å‚·", "å¿ƒè·³åœ", "é‡æºº", "é‡ç—‡", "ç—…å±"];
const accKeywords = ["æ„å¤–", "è»Šç¦", "æ’", "ç«è­¦", "è·Œ", "å¢®", "çˆ†ç‚¸", "å·¥å‚·", "å¤±æ§", "ç¿»è»Š", "å¡Œé™·"];

// === Enhanced categorization function ===
function categorize(title) {
    const t = title.toLowerCase();
    
    // Try new 12-category system first
    for (const [catKey, catData] of Object.entries(categoryConfig)) {
        for (const keyword of catData.keywords) {
            if (t.includes(keyword.toLowerCase())) {
                return catKey;
            }
        }
    }
    
    // Fallback to legacy categorization
    for (let kw of fatalKeywords) if (t.includes(kw)) return 'FATAL';
    for (let kw of critKeywords) if (t.includes(kw)) return 'CRIT';
    for (let kw of accKeywords) if (t.includes(kw)) return 'ACC';
    return 'OTHER';
}

// === å¹´é½¡æ¨ç®— ===
function extractAge(title) {
    const patterns = [/(\d{1,3})\s*æ­²/, /(\d{1,2})æ—¬/, /å¹´ç´„\s*(\d{1,3})/, /(\d{1,3})\s*yo/i];
    for (let p of patterns) {
        const match = title.match(p);
        if (match) {
            let age = parseInt(match[1]);
            if (title.includes('æ—¬') && age < 20) age *= 10;
            if (age > 0 && age < 150) return age;
        }
    }
    return null;
}

// === è§£ç¢¼å‡½æ•¸ ===
function safeDecode(str) {
    try { return decodeURIComponent(str.replace(/\+/g, ' ')); }
    catch (e) { return str; }
}

// === è§£ææ•¸æ“š ===
function parseData(raw) {
    const lines = raw.split(/\r?\n/).filter(l => l.trim());
    const events = [];

    for (let line of lines) {
        let text = safeDecode(line);
        let parts = text.split('\t');
        if (parts.length < 3) parts = text.split(/\s{2,}/);
        if (parts.length < 2) continue;

        let dateStr = parts[0].trim().replace(/[\[\]]/g, '');
        let url = parts.find(p => /^https?:\/\/[^\s\t]+/.test(p)) || '#';
        let title = parts.filter(p => p !== dateStr && p !== url).map(safeDecode).join(' ').trim();

        if (!dateStr || !title) continue;

        let dateParts = dateStr.split(/[\/-]/);
        if (dateParts.length === 3) {
            let a = parseInt(dateParts[0], 10);
            let b = parseInt(dateParts[1], 10);
            let c = parseInt(dateParts[2], 10);
            let d, m, y;

            if (c > 1000) { d = a; m = b; y = c; }
            else if (a > 1000) { y = a; m = b; d = c; }
            else { d = a; m = b; y = 2000 + c; }

            y = String(y).padStart(4, '20');
            m = String(m).padStart(2, '0');
            d = String(d).padStart(2, '0');
            dateStr = `${y}-${m}-${d}`;

            if (isNaN(new Date(dateStr).getTime())) continue;
        } else continue;

        events.push({
            date: dateStr,
            url,
            title,
            category: categorize(title),
            age: extractAge(title)
        });
    }

    events.sort((a, b) => new Date(b.date) - new Date(a.date));
    return events;
}

// === é—œéµè©çµ±è¨ˆ ===
function getKeywordStats(events) {
    const keywords = {};
    const importantWords = ['çŒæ­»', 'å¿ƒè‡Ÿ', 'è»Šç¦', 'æ„å¤–', 'æšˆå€’', 'æ˜è¿·', 'ç«è­¦', 'å¢®æ¨“', 'æººæ–ƒ', 'å·¥å‚·', 'è‡ªæ®º', 'è·³æ¨“', 'ä¸­é¢¨', 'ç™Œç—‡', 'å¿ƒè‚Œæ¢—å¡', 'è…¦æº¢è¡€', 'éå‹', 'å±æ®†', 'ç—…é€'];

    for (let e of events) {
        for (let kw of importantWords) {
            if (e.title.includes(kw)) {
                keywords[kw] = (keywords[kw] || 0) + 1;
            }
        }
    }
    return Object.entries(keywords).sort((a, b) => b[1] - a[1]).slice(0, 15);
}

// === æ¸²æŸ“äº‹ä»¶åˆ—è¡¨ ===
function renderList(events) {
    const container = document.getElementById('log-stream');
    container.innerHTML = '';

    // Calculate pagination
    totalPages = Math.ceil(events.length / itemsPerPage);
    const startIdx = (currentPage - 1) * itemsPerPage;
    const endIdx = Math.min(startIdx + itemsPerPage, events.length);
    const pageEvents = events.slice(startIdx, endIdx);

    // Render current page events
    for (let e of pageEvents) {
        const div = document.createElement('div');
        div.className = `log-item type-${e.category}`;

        const ageDisplay = e.age ? `<span class="age-badge">ç´„${e.age}æ­²</span>` : '';
        
        // Get category display name with fallback for legacy categories
        let categoryName, categoryColor;
        if (categoryConfig[e.category]) {
            categoryName = categoryConfig[e.category].name;
            categoryColor = categoryConfig[e.category].color;
        } else {
            // Legacy category fallback
            const legacyNames = {
                'FATAL': 'è‡´å‘½',
                'CRIT': 'å±æ€¥',
                'ACC': 'æ„å¤–',
                'OTHER': 'å…¶ä»–'
            };
            categoryName = legacyNames[e.category] || 'å…¶ä»–';
            categoryColor = '#666';
        }
        
        const categoryBadge = `<span class="category-badge" style="background:${categoryColor};">${categoryName}</span>`;
        const eventId = `${e.date}-${e.title.slice(0, 20)}`;
        const isLit = candleCounts[eventId] > 0;

        div.innerHTML = `
            <span class="date">${e.date} ${ageDisplay} ${categoryBadge}</span>
            <span class="title"><a href="${e.url}" target="_blank">${e.title}</a></span>
            <span class="candle ${isLit ? 'lit' : ''}" data-id="${eventId}" onclick="lightCandle(this)">ğŸ•¯ï¸</span>
        `;
        container.appendChild(div);
    }

    // Update pagination info
    document.getElementById('current-page-num').textContent = currentPage;
    document.getElementById('total-page-num').textContent = totalPages;
    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = currentPage === totalPages;
    
    // Show message if no results
    if (events.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">æ²’æœ‰ç¬¦åˆçš„è¨˜éŒ„</div>';
        container.innerHTML = `
            <div style="text-align:center; padding: 60px 20px; margin: 40px auto; max-width: 500px; border: 2px dashed var(--c-dim); border-radius: 8px; background: rgba(58, 74, 90, 0.1);">
                <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">ğŸ“­</div>
                <div style="font-size: 20px; font-weight: 600; color: var(--c-accent); margin-bottom: 8px;">æ²’æœ‰ç¬¦åˆçš„è¨˜éŒ„</div>
                <div style="font-size: 14px; color: var(--c-dim); margin-top: 12px;">è«‹å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æ¸…é™¤ç¯©é¸</div>
            </div>
        `;
    }
}

// Pagination function
function changePage(direction) {
    const newPage = currentPage + direction;
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderList(filteredEvents);
        // Scroll to top of list
        document.getElementById('log-stream').scrollTop = 0;
    }
}

// === é»ç‡­åŠŸèƒ½ ===
function lightCandle(el) {
    const id = el.dataset.id;
    candleCounts[id] = (candleCounts[id] || 0) + 1;
    totalCandles++;
    el.classList.add('lit');
    localStorage.setItem('candleCounts', JSON.stringify(candleCounts));
    document.getElementById('total-candles').textContent = totalCandles;

    // é¡¯ç¤ºçŸ­æš«è¨Šæ¯
    el.style.transform = 'translateY(-50%) scale(1.5)';
    setTimeout(() => el.style.transform = '', 300);

    // Check progression for awakening protocol
    if (typeof Progression !== 'undefined') {
        Progression.checkMonitorProgress();
    }
}

// === æ›´æ–°çµ±è¨ˆ ===
function updateStats(events) {
    const fatal = events.filter(e => e.category === 'FATAL').length;
    const crit = events.filter(e => e.category === 'CRIT').length;
    const acc = events.filter(e => e.category === 'ACC').length;
    const other = events.filter(e => e.category === 'OTHER').length;

    document.getElementById('total-count').textContent = events.length;
    document.getElementById('stat-fatal').textContent = fatal;
    document.getElementById('stat-crit').textContent = crit;
    document.getElementById('stat-acc').textContent = acc;
    document.getElementById('stat-other').textContent = other;

    // æ›´æ–°æœŸé–“é¡¯ç¤º
    if (events.length > 0) {
        const dates = events.map(e => e.date).sort();
        document.getElementById('period-display').textContent =
            `${dates[0]} â†’ ${dates[dates.length - 1]} | ${events.length} å®—`;
    }
}

// === æ¸²æŸ“é—œéµè©é›² ===
function renderKeywordCloud(events) {
    const container = document.getElementById('keyword-cloud');
    const stats = getKeywordStats(events);

    if (stats.length === 0) {
        container.innerHTML = '<span style="color:#666">æš«ç„¡é—œéµè©æ•¸æ“š</span>';
        return;
    }

    const maxCount = stats[0][1];
    container.innerHTML = stats.map(([kw, count]) => {
        const size = 0.8 + (count / maxCount) * 0.6;
        return `<span class="keyword-tag" style="font-size:${size}em">${kw}(${count})</span>`;
    }).join('');
}

// === ä»Šæ—¥èšç„¦ ===
function showTodayFocus(events) {
    if (!events.length) return;

    const fatalEvents = events.filter(e => e.category === 'FATAL');
    const pool = fatalEvents.length > 0 ? fatalEvents : events;
    const random = pool[Math.floor(Math.random() * pool.length)];

    document.querySelector('#today-focus .focus-content').textContent = random.title;
    document.querySelector('#today-focus .focus-date').textContent = random.date;
}

// === æœå°‹éæ¿¾ ===
function filterEvents() {
    const query = document.getElementById('search-input').value.toLowerCase().trim();
    const ageVal = document.getElementById('age-filter').value;
    const categoryVal = document.getElementById('category-filter').value;

    filteredEvents = allEvents.filter(e => {
        let match = true;
        if (query) match = e.title.toLowerCase().includes(query) || e.date.includes(query);
        if (ageVal && match) {
            const targetAge = parseInt(ageVal);
            if (e.age) match = Math.abs(e.age - targetAge) <= 5;
            else match = false;
        }
        if (categoryVal && match) {
            match = e.category === categoryVal;
        }
        return match;
    });

    currentPage = 1; // Reset to first page when filtering
    renderList(filteredEvents);
    updateStats(filteredEvents);
    
    // Scroll to top of list when filters are applied
    document.getElementById('log-stream').scrollTop = 0;
}

// === åŒé½¡éæ¿¾ ===
function filterByAge() {
    const ageVal = document.getElementById('peer-age').value;
    if (!ageVal) {
        document.getElementById('peer-result').textContent = 'è«‹è¼¸å…¥å¹´é½¡';
        return;
    }

    const targetAge = parseInt(ageVal);
    const matches = allEvents.filter(e => e.age && Math.abs(e.age - targetAge) <= 5);

    document.getElementById('peer-result').innerHTML =
        matches.length > 0
            ? `æ‰¾åˆ° <strong>${matches.length}</strong> å®— ${targetAge}Â±5æ­² çš„è¨˜éŒ„`
            : 'æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„';

    if (matches.length > 0) {
        filteredEvents = matches;
        renderList(filteredEvents);
        updateStats(filteredEvents);
    }
}

// === ç”Ÿå‘½è¨ˆç®—å™¨ ===
function calculateLife() {
    const age = parseInt(document.getElementById('user-age').value) || 30;
    userAge = age;
    const lifeExpectancy = 85;
    const daysLived = age * 365;
    const daysRemaining = Math.max(0, (lifeExpectancy - age) * 365);
    const percentUsed = ((age / lifeExpectancy) * 100).toFixed(1);

    // è¨ˆç®—è·2027å¹è§’ç¯€é€²åº¦ï¼ˆå¾2019/12/1èµ·ç®—ï¼‰
    const startDate = new Date('2019-12-01T00:00:00+08:00');
    const target2027 = new Date('2027-10-01T00:00:00+08:00'); // å¹è§’ç¯€
    const now = new Date();
    const totalDuration = target2027 - startDate;
    const elapsed = now - startDate;
    const daysTo2027 = Math.max(0, Math.ceil((target2027 - now) / 86400000));
    const percentTo2027 = Math.min(100, ((elapsed / totalDuration) * 100)).toFixed(1);

    // æ›´æ–°4æ ¼çµ±è¨ˆ
    const daysLivedBox = document.getElementById('days-lived-box');
    const daysLeftBox = document.getElementById('days-left-box');
    const lifePercentBox = document.getElementById('life-percent-box');
    const to2027Box = document.getElementById('to-2027-box');

    if (daysLivedBox) daysLivedBox.textContent = daysLived.toLocaleString();
    if (daysLeftBox) daysLeftBox.textContent = daysRemaining.toLocaleString();
    if (lifePercentBox) lifePercentBox.textContent = percentUsed + '%';
    if (to2027Box) to2027Box.textContent = percentTo2027 + '%';

    // æ›´æ–°èˆŠç‰ˆå¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const oldDaysLived = document.getElementById('days-lived');
    const oldDaysLeft = document.getElementById('days-left');
    const oldProgress = document.getElementById('life-progress');
    if (oldDaysLived) oldDaysLived.textContent = daysLived.toLocaleString();
    if (oldDaysLeft) oldDaysLeft.textContent = daysRemaining.toLocaleString();
    if (oldProgress) oldProgress.textContent = percentUsed + '%';

    // æ›´æ–°çµæœæ–‡å­—
    const weeksLeft = Math.floor(daysRemaining / 7);
    const monthsLeft = Math.floor(daysRemaining / 30);

    document.getElementById('life-result').innerHTML = `
        <span style="color:var(--c-dim);font-size:11px;">å‡è¨­å£½å‘½85æ­²ï¼Œé¤˜ç”Ÿç´„</span><br>
        ç´„ <strong>${weeksLeft.toLocaleString()}</strong> é€± / <strong>${monthsLeft}</strong> æœˆ<br>
        <span style="color:var(--c-fatal);">è· 2027 å¹è§’ç¯€é‚„æœ‰ ${daysTo2027} å¤©ï¼ˆå·²é ${percentTo2027}%ï¼‰</span>
    `;
}

// === å€’æ•¸è¨ˆæ™‚ ===
function updateCountdown() {
    const target = new Date('2027-10-01T00:00:00+08:00');
    const now = new Date();
    const diff = target - now;

    if (diff <= 0) {
        document.getElementById('countdown-days').textContent = '0';
        document.getElementById('countdown-detail').textContent = 'æ™‚å€™å·²åˆ°';
        return;
    }

    const days = Math.floor(diff / 86400000);
    const hours = Math.floor((diff % 86400000) / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);

    document.getElementById('countdown-days').textContent = days.toLocaleString();
    document.getElementById('countdown-detail').textContent =
        `${hours}æ™‚${mins}åˆ† â†’ 2027-10-01`;
}

// === æ¯æ—¥å…§å®¹ ===
function showDailyContent() {
    const today = new Date().getDate();
    const verse = dailyVerses[today % dailyVerses.length];
    const question = dailyQuestions[today % dailyQuestions.length];
    const wisdom = wisdomQuotes[today % wisdomQuotes.length];

    document.getElementById('daily-verse').innerHTML =
        `ğŸ“– <strong>ä»Šæ—¥ç¶“æ–‡ï¼š</strong>${verse.text}<br><span style="color:#ff6666;font-size:12px;">â€” ${verse.ref}</span>`;
    document.getElementById('daily-question').innerHTML = question;

    // æ›´æ–°é ‚éƒ¨æ™ºæ…§åè¨€
    document.getElementById('wisdom-quote').textContent = `ã€Œ${wisdom.text}ã€`;
    document.getElementById('wisdom-source').textContent = `â€” ${wisdom.source}`;
}

// === é»˜å“€æ¨¡å¼ ===
function toggleMourningMode() {
    document.body.classList.toggle('mourning-mode');
}

// === è¼‰å…¥è²¼ä¸Šæ•¸æ“š ===
function loadPastedData() {
    const input = document.getElementById('paste-input');
    if (!input || !input.value.trim()) return;

    allEvents = parseData(input.value);
    filteredEvents = [...allEvents];

    renderList(filteredEvents);
    updateStats(filteredEvents);
    renderKeywordCloud(filteredEvents);
    showTodayFocus(filteredEvents);

    console.log(`âœ… å·²è¼‰å…¥ ${allEvents.length} ç­†æ•¸æ“š`);
}

// === æª”æ¡ˆè™•ç† ===
function handleFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('paste-input').value = e.target.result;
        loadPastedData();
    };
    reader.readAsText(file);
}

// === è‡ªå‹•è¼‰å…¥ data.txt ===
// HOOK FOR EXTERNAL JSON DATA:
// To load data from an external JSON API, replace the fetch URL below with your API endpoint.
// Expected JSON format: Array of objects with {date, title, url, age?, category?}
// Example: fetch('https://api.example.com/events.json')
function autoLoadData() {
    fetch('data/data.txt')
        .then(response => {
            if (!response.ok) throw new Error('data.txt not found');
            return response.text();
        })
        .then(text => {
            document.getElementById('paste-input').value = text;
            loadPastedData();
            console.log('âœ… è‡ªå‹•å¾ data.txt è¼‰å…¥æ•¸æ“š');
        })
        .catch(() => console.log('âš ï¸ æœªæ‰¾åˆ° data.txtï¼Œè«‹æ‰‹å‹•è²¼ä¸Šæ•¸æ“š'));
}

// Function to load external JSON data (ready for future use)
// Usage: Call loadExternalJSON('https://api.example.com/events.json') to load data from external API
// This replaces the default data.txt loading mechanism
function loadExternalJSON(url) {
    fetch(url)
        .then(response => response.json())
        .then(data => {
/**
 * Load data from external JSON endpoint
 * 
 * Expected JSON format: Array of objects with the following shape:
 * [
 *   {
 *     "date": "2026-01-31",           // Required: ISO date string
 *     "title": "äº‹ä»¶æ¨™é¡Œ",             // Required: Event title
 *     "url": "https://...",            // Required: Source URL
 *     "age": 45,                       // Optional: Age (number)
 *     "category": "çŒæ­»"               // Optional: Category (will auto-categorize if missing)
 *   }
 * ]
 * 
 * Valid categories: çŒæ­», å¤©ç½, ç¶“æ¿Ÿ, é†«è—¥, å·¥æ¥­æ„å¤–, äº¤é€š, ç«è­¦, AIå®‰å…¨, æ‚²åŠ‡, æ²»å®‰, å®—æ•™æœ«ä¸–, é›¢ä¸–
 */
function loadExternalJSON(url) {
    // Show loading state
    const container = document.getElementById('log-stream');
    container.innerHTML = `
        <div style="text-align:center; padding: 80px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px; animation: pulse 1.5s infinite;">â³</div>
            <div style="font-size: 18px; color: var(--c-accent);">æ­£åœ¨è¼‰å…¥å¤–éƒ¨è³‡æ–™...</div>
            <div style="font-size: 14px; color: var(--c-dim); margin-top: 8px;">${url}</div>
        </div>
    `;
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!Array.isArray(data)) {
                throw new Error('Expected JSON array, got ' + typeof data);
            }
            
            // Convert JSON to internal format
            allEvents = data.map(item => ({
                date: item.date || '',
                title: item.title || '',
                url: item.url || '#',
                age: item.age || null,
                category: item.category || categorize(item.title)
            }));
            filteredEvents = allEvents;
            currentPage = 1;
            renderList(filteredEvents);
            updateStats(filteredEvents);
            console.log(`âœ… Loaded ${allEvents.length} events from external JSON`);
        })
        .catch(err => console.error('Failed to load external JSON:', err));
        .catch(err => {
            // Show error state with detailed message
            console.error('Failed to load external JSON:', err);
            container.innerHTML = `
                <div style="text-align:center; padding: 60px 20px; margin: 40px auto; max-width: 600px; border: 2px solid var(--c-fatal); border-radius: 8px; background: rgba(255, 42, 42, 0.1);">
                    <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                    <div style="font-size: 20px; font-weight: 600; color: var(--c-fatal); margin-bottom: 8px;">è¼‰å…¥å¤–éƒ¨è³‡æ–™å¤±æ•—</div>
                    <div style="font-size: 14px; color: var(--c-dim); margin-top: 12px; font-family: monospace; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 4px; word-break: break-all;">
                        ${err.message}
                    </div>
                    <div style="font-size: 13px; color: var(--c-dim); margin-top: 16px;">è«‹æª¢æŸ¥ URL æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç¨å¾Œå†è©¦</div>
                </div>
            `;
        });
}

// === åŒ¯å‡ºå¿«ç…§ ===
function exportSnapshot() {
    const html = document.documentElement.outerHTML;
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vital-threat-monitor-${new Date().toISOString().slice(0,10)}.html`;
    a.click();
    URL.revokeObjectURL(url);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUAL EFFECTS - ECG, RADAR, SOUL PARTICLES, BACKGROUND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// === èƒŒæ™¯ç²’å­ ===
const particleBg = document.getElementById('particle-bg');
const particleCtx = particleBg.getContext('2d');
const bgParticles = [];

function resizeParticleBg() {
    particleBg.width = window.innerWidth;
    particleBg.height = window.innerHeight;
    initBgParticles();
}

function initBgParticles() {
    bgParticles.length = 0;
    const count = Math.floor((particleBg.width * particleBg.height) / 15000);
    for (let i = 0; i < count; i++) {
        bgParticles.push({
            x: Math.random() * particleBg.width,
            y: Math.random() * particleBg.height,
            vx: (Math.random() - 0.5) * 0.3,
            vy: -0.2 - Math.random() * 0.5,
            size: 0.5 + Math.random() * 1.5,
            alpha: 0.1 + Math.random() * 0.4,
            color: Math.random() > 0.8 ? '#a855f7' : (Math.random() > 0.5 ? '#00f3ff' : '#ffffff')
        });
    }
}

function drawBgParticles() {
    particleCtx.fillStyle = 'rgba(3,4,5,0.1)';
    particleCtx.fillRect(0, 0, particleBg.width, particleBg.height);

    bgParticles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;

        if (p.y < -10) { p.y = particleBg.height + 10; p.x = Math.random() * particleBg.width; }
        if (p.x < 0) p.x = particleBg.width;
        if (p.x > particleBg.width) p.x = 0;

        particleCtx.beginPath();
        particleCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);

        const hex = p.color.slice(1);
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        particleCtx.fillStyle = `rgba(${r},${g},${b},${p.alpha})`;
        particleCtx.fill();
    });

    requestAnimationFrame(drawBgParticles);
}

resizeParticleBg();
window.addEventListener('resize', resizeParticleBg);

// === ECG å¿ƒé›»åœ– ===
const ecgCanvas = document.getElementById('ecg-canvas');
const ecgCtx = ecgCanvas.getContext('2d');
let ecgX = 0;

function resizeECG() {
    ecgCanvas.width = ecgCanvas.offsetWidth * 2;
    ecgCanvas.height = ecgCanvas.offsetHeight * 2;
    ecgCtx.scale(2, 2);
}
resizeECG();
window.addEventListener('resize', resizeECG);

function drawECG() {
    const w = ecgCanvas.offsetWidth;
    const h = ecgCanvas.offsetHeight;
    const midY = h / 2;

    ecgCtx.fillStyle = 'rgba(0,0,0,0.15)';
    ecgCtx.fillRect(0, 0, w, h);

    ecgX += 2;
    if (ecgX > w) ecgX = 0;

    const cycle = (ecgX % 100);
    let y = midY;
    if (cycle < 8) y = midY;
    else if (cycle < 12) y = midY - 4;
    else if (cycle < 16) y = midY + 2;
    else if (cycle < 22) y = midY - (h * 0.6);
    else if (cycle < 28) y = midY + (h * 0.25);
    else if (cycle < 36) y = midY;
    else if (cycle < 55) y = midY - 6;
    else y = midY;

    ecgCtx.strokeStyle = '#00ff41';
    ecgCtx.lineWidth = 2;
    ecgCtx.shadowColor = '#00ff41';
    ecgCtx.shadowBlur = 10;
    ecgCtx.beginPath();
    ecgCtx.moveTo(ecgX - 2, midY);
    ecgCtx.lineTo(ecgX, y);
    ecgCtx.stroke();

    ecgCtx.fillStyle = 'rgba(0,255,65,0.8)';
    ecgCtx.fillRect(ecgX, 0, 2, h);

    requestAnimationFrame(drawECG);
}

// === é›·é”å‹•ç•« ===
const radarCanvas = document.getElementById('radar-canvas');
const radarCtx = radarCanvas.getContext('2d');
let radarAngle = 0;

function resizeRadar() {
    radarCanvas.width = radarCanvas.offsetWidth * 2;
    radarCanvas.height = radarCanvas.offsetHeight * 2;
    radarCtx.scale(2, 2);
}
resizeRadar();
window.addEventListener('resize', resizeRadar);

const matrixChars = '01ç”Ÿæ­»æ„å¤–ç½é›£è­¦å‘Šå±éšªæœ«ä¸–ä¸ƒå¹´å¯©åˆ¤æ°¸æ†éˆé­‚DEATHALERTTHREATFATAL';
const columns = [];

function initMatrixColumns() {
    const w = radarCanvas.offsetWidth;
    const h = radarCanvas.offsetHeight;
    const colCount = Math.floor(w / 18);
    columns.length = 0;
    for (let i = 0; i < colCount; i++) {
        columns.push({
            x: i * 18,
            y: Math.random() * h,
            speed: 1.5 + Math.random() * 3
        });
    }
}
initMatrixColumns();
window.addEventListener('resize', initMatrixColumns);

function drawRadar() {
    const w = radarCanvas.offsetWidth;
    const h = radarCanvas.offsetHeight;
    const cx = w / 2;
    const cy = h / 2;
    const maxR = Math.min(cx, cy) * 0.8;

    radarCtx.fillStyle = 'rgba(0,5,10,0.12)';
    radarCtx.fillRect(0, 0, w, h);

    // Matrix æ•¸å­—é›¨
    radarCtx.font = '14px "Share Tech Mono", monospace';
    columns.forEach(col => {
        const rand = Math.random();
        if (rand < 0.5) radarCtx.fillStyle = 'rgba(0,255,65,0.6)';
        else if (rand < 0.8) radarCtx.fillStyle = 'rgba(0,243,255,0.5)';
        else radarCtx.fillStyle = 'rgba(168,85,247,0.5)';

        const char = matrixChars[Math.floor(Math.random() * matrixChars.length)];
        radarCtx.fillText(char, col.x, col.y);

        col.y += col.speed;
        if (col.y > h) {
            col.y = -20;
            col.speed = 1.5 + Math.random() * 3;
        }
    });

    // é›·é”åœ“ç’°
    radarCtx.strokeStyle = 'rgba(0,243,255,0.25)';
    radarCtx.lineWidth = 1;
    for (let i = 1; i <= 4; i++) {
        radarCtx.beginPath();
        radarCtx.arc(cx, cy, maxR * i / 4, 0, Math.PI * 2);
        radarCtx.stroke();
    }

    // åå­—ç·š
    radarCtx.beginPath();
    radarCtx.moveTo(cx - maxR, cy);
    radarCtx.lineTo(cx + maxR, cy);
    radarCtx.moveTo(cx, cy - maxR);
    radarCtx.lineTo(cx, cy + maxR);
    radarCtx.stroke();

    // æƒæå…‰æŸ
    radarAngle += 0.012;
    for (let i = 0; i < 10; i++) {
        const trailAngle = radarAngle - i * 0.06;
        const alpha = 0.4 - i * 0.038;
        if (alpha <= 0) continue;

        const gradient = radarCtx.createLinearGradient(
            cx, cy,
            cx + Math.cos(trailAngle) * maxR,
            cy + Math.sin(trailAngle) * maxR
        );
        gradient.addColorStop(0, `rgba(0,243,255,${alpha})`);
        gradient.addColorStop(1, 'rgba(0,243,255,0)');

        radarCtx.strokeStyle = gradient;
        radarCtx.lineWidth = 2.5 - i * 0.2;
        radarCtx.beginPath();
        radarCtx.moveTo(cx, cy);
        radarCtx.lineTo(cx + Math.cos(trailAngle) * maxR, cy + Math.sin(trailAngle) * maxR);
        radarCtx.stroke();
    }

    // ä¸­å¿ƒå…‰é»
    const centerGlow = radarCtx.createRadialGradient(cx, cy, 0, cx, cy, 12);
    centerGlow.addColorStop(0, 'rgba(0,243,255,0.9)');
    centerGlow.addColorStop(1, 'rgba(0,243,255,0)');
    radarCtx.fillStyle = centerGlow;
    radarCtx.beginPath();
    radarCtx.arc(cx, cy, 12, 0, Math.PI * 2);
    radarCtx.fill();

    requestAnimationFrame(drawRadar);
}

// === éˆé­‚ç²’å­ ===
const soulCanvas = document.getElementById('soul-canvas');
const soulCtx = soulCanvas.getContext('2d');
const soulParticles = [];

function resizeSoul() {
    soulCanvas.width = soulCanvas.offsetWidth * 2;
    soulCanvas.height = soulCanvas.offsetHeight * 2;
    soulCtx.scale(2, 2);
    initSoulParticles();
}

function initSoulParticles() {
    const w = soulCanvas.offsetWidth;
    const h = soulCanvas.offsetHeight;
    soulParticles.length = 0;
    const count = Math.floor((w * h) / 6000);
    for (let i = 0; i < count; i++) {
        soulParticles.push({
            x: Math.random() * w,
            y: Math.random() * h,
            vx: (Math.random() - 0.5) * 0.4,
            vy: -0.4 - Math.random() * 0.8,
            size: 1 + Math.random() * 2.5,
            alpha: 0.2 + Math.random() * 0.5,
            color: Math.random() > 0.7 ? '#a855f7' : (Math.random() > 0.5 ? '#00f3ff' : '#ffffff')
        });
    }
}

resizeSoul();
window.addEventListener('resize', resizeSoul);

function drawSoulParticles() {
    const w = soulCanvas.offsetWidth;
    const h = soulCanvas.offsetHeight;

    soulCtx.fillStyle = 'rgba(0,5,10,0.08)';
    soulCtx.fillRect(0, 0, w, h);

    soulParticles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.alpha += (Math.random() - 0.5) * 0.02;
        p.alpha = Math.max(0.1, Math.min(0.7, p.alpha));

        if (p.y < -10) { p.y = h + 10; p.x = Math.random() * w; }
        if (p.x < 0) p.x = w;
        if (p.x > w) p.x = 0;

        const hex = p.color.slice(1);
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);

        soulCtx.beginPath();
        soulCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        soulCtx.fillStyle = `rgba(${r},${g},${b},${p.alpha})`;
        soulCtx.shadowColor = p.color;
        soulCtx.shadowBlur = 10;
        soulCtx.fill();
    });

    requestAnimationFrame(drawSoulParticles);
}

// === å•Ÿå‹•æ‰€æœ‰å‹•ç•« ===
function startAllAnimations() {
    drawBgParticles();
    drawECG();
    drawRadar();
    drawSoulParticles();
}

// === å“²ç†é–‹å ´è™•ç† ===
document.getElementById('philosophy-overlay').addEventListener('click', function() {
    this.classList.add('fade-out');
    setTimeout(() => this.style.display = 'none', 1500);
});

// === é é¢åˆå§‹åŒ– ===
window.addEventListener('load', () => {
    startAllAnimations();
    updateCountdown();
    setInterval(updateCountdown, 1000);
    showDailyContent();
    calculateLife();
    document.getElementById('total-candles').textContent = totalCandles;
    autoLoadData();

    // å•Ÿå‹•æ­»äº¡åŒæ­¥è¨ˆæ•¸å™¨
    startDeathCounter();

    console.log('ğŸš€ VITAL LIFE MONITOR V9.0 â€” æœ«ä¸–å²è©©ç‰ˆ å·²å•Ÿå‹•');
    console.log('ğŸ’€ ç”Ÿæ­»åªåœ¨ä¸€ç·šä¹‹é–“');
    console.log('âœ¨ ä»Šç”Ÿèˆ‡æ°¸æ†ï¼Œç”¦é†’èˆ‡æ˜æ²‰');
});

// === æ­»äº¡åŒæ­¥è¨ˆæ•¸å™¨ ===
let deathEntryTime = null;
const DEATHS_PER_SECOND = 1.8;

function startDeathCounter() {
    deathEntryTime = Date.now();
    updateDeathCounter();
    setInterval(updateDeathCounter, 500);
}

function updateDeathCounter() {
    if (!deathEntryTime) return;

    const elapsed = (Date.now() - deathEntryTime) / 1000;
    const deathsSinceEntry = Math.floor(elapsed * DEATHS_PER_SECOND);

    const now = new Date();
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const secondsToday = (now - startOfDay) / 1000;
    const deathsToday = Math.floor(secondsToday * DEATHS_PER_SECOND);

    document.getElementById('death-since-entry').textContent = deathsSinceEntry.toLocaleString();
    document.getElementById('death-today').textContent = deathsToday.toLocaleString();
}
</script>

<script>
/**
 * Iframe å…ƒç´ é«˜äº®æ³¨å…¥è„šæœ¬
 * éœ€è¦åœ¨ç›®æ ‡ç½‘ç«™ä¸­å¼•å…¥æ­¤è„šæœ¬æ¥æ”¯æŒè·¨åŸŸ iframe é«˜äº®åŠŸèƒ½
 *
 * ä½¿ç”¨æ–¹æ³•ï¼š
 * 1. å°†æ­¤è„šæœ¬æ·»åŠ åˆ°ç›®æ ‡ç½‘ç«™çš„ HTML ä¸­
 * 2. æˆ–é€šè¿‡æµè§ˆå™¨æ‰©å±•ã€ç”¨æˆ·è„šæœ¬ç­‰æ–¹å¼æ³¨å…¥
 */

(function () {
  "use strict";

  // æ£€æŸ¥æ˜¯å¦åœ¨ iframe ä¸­
  if (window.self === window.top) {
    return; // ä¸åœ¨ iframe ä¸­ï¼Œä¸æ‰§è¡Œ
  }

  // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
  if (window.__iframeHighlightInitialized) {
    return;
  }
  window.__iframeHighlightInitialized = true;
  console.log("Iframe é«˜äº®è„šæœ¬å·²åŠ è½½");

  // åˆ›å»ºé«˜äº®è¦†ç›–å±‚
  var overlay = document.createElement("div");
  overlay.id = "iframe-highlight-overlay";
  overlay.style.cssText = "\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    pointer-events: none;\n    z-index: 999999;\n    overflow: hidden;\n  ";

  // åˆ›å»ºæ‚¬åœé«˜äº®æ¡†ï¼ˆè™šçº¿è¾¹æ¡†ï¼‰
  var highlightBox = document.createElement("div");
  highlightBox.id = "iframe-highlight-box";
  highlightBox.style.cssText = "\n    position: absolute;\n    border: 2px dashed #007AFF;\n    background: rgba(0, 122, 255, 0.08);\n    pointer-events: none;\n    display: none;\n    transition: all 0.1s ease;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8);\n    border-radius: 2px;\n  ";

  // åˆ›å»ºé€‰ä¸­èŠ‚ç‚¹çš„å¸¸é©»é«˜äº®æ¡†ï¼ˆå®çº¿è¾¹æ¡†ï¼‰
  var selectedBox = document.createElement("div");
  selectedBox.id = "iframe-selected-box";
  selectedBox.style.cssText = "\n    position: absolute;\n    border: 2px solid #007AFF;\n    pointer-events: none;\n    display: none;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 107, 53, 0.4);\n    border-radius: 2px;\n    z-index: 1000000;\n  ";

  // åˆ›å»ºæ‚¬åœæ ‡ç­¾æ˜¾ç¤º
  var tagLabel = document.createElement("div");
  tagLabel.id = "iframe-tag-label";
  tagLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 2px 6px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 2px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000001;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n    font-weight: 500;\n  ";

  // åˆ›å»ºé€‰ä¸­èŠ‚ç‚¹æ ‡ç­¾
  var selectedLabel = document.createElement("div");
  selectedLabel.id = "iframe-selected-label";
  selectedLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 3px 8px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 3px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000002;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);\n    font-weight: 600;\n  ";
  overlay.appendChild(highlightBox);
  overlay.appendChild(selectedBox);
  overlay.appendChild(tagLabel);
  overlay.appendChild(selectedLabel);
  document.body.appendChild(overlay);

  // å­˜å‚¨å½“å‰é€‰ä¸­çš„å…ƒç´ 
  var selectedElement = null;
  var highlightEnabled = false;

  // æ›´æ–°é€‰ä¸­å…ƒç´ çš„é«˜äº®æ˜¾ç¤º
  function updateSelectedHighlight(element) {
    console.log("updateSelectedHighlight called with:", element);
    if (!element) {
      selectedBox.style.display = "none";
      selectedLabel.style.display = "none";
      selectedElement = null;
      console.log("Cleared selected highlight");
      return;
    }
    selectedElement = element;
    var rect = element.getBoundingClientRect();
    console.log("Selected element rect:", rect);

    // æ›´æ–°é€‰ä¸­é«˜äº®æ¡†ä½ç½®
    selectedBox.style.display = "block";
    selectedBox.style.left = "".concat(rect.left - 2, "px");
    selectedBox.style.top = "".concat(rect.top - 2, "px");
    selectedBox.style.width = "".concat(rect.width + 4, "px");
    selectedBox.style.height = "".concat(rect.height + 4, "px");

    // æ›´æ–°é€‰ä¸­æ ‡ç­¾ä½ç½®å’Œå†…å®¹
    selectedLabel.style.display = "block";
    selectedLabel.textContent = "\u2713 <".concat(element.tagName.toLowerCase(), ">");

    // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†çª—
    var labelTop = rect.top - 28;
    var labelLeft = rect.left;

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºé¡¶éƒ¨ï¼Œæ˜¾ç¤ºåœ¨å…ƒç´ ä¸‹æ–¹
    if (labelTop < 5) {
      labelTop = rect.bottom + 5;
    }

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºå³ä¾§ï¼Œå‘å·¦è°ƒæ•´
    var labelWidth = selectedLabel.offsetWidth || 100; // é¢„ä¼°å®½åº¦
    if (labelLeft + labelWidth > window.innerWidth - 10) {
      labelLeft = window.innerWidth - labelWidth - 10;
    }
    selectedLabel.style.left = "".concat(Math.max(5, labelLeft), "px");
    selectedLabel.style.top = "".concat(labelTop, "px");
    console.log("Selected highlight positioned at:", {
      left: selectedBox.style.left,
      top: selectedBox.style.top,
      width: selectedBox.style.width,
      height: selectedBox.style.height
    });
  }
  function getElementSelector(element) {
    if (!(element instanceof Element)) throw new Error('Argument must be a DOM element');
    var segments = [];
    var current = element;
    while (current !== document.documentElement) {
      var selector = '';
      // ä¼˜å…ˆæ£€æŸ¥å”¯ä¸€ID
      if (current.id && document.querySelectorAll("#".concat(current.id)).length === 1) {
        segments.unshift("#".concat(current.id));
        break; // IDå”¯ä¸€ï¼Œæ— éœ€ç»§ç»­å‘ä¸Š
      }

      // ç”Ÿæˆç±»åé€‰æ‹©å™¨ï¼ˆå–ç¬¬ä¸€ä¸ªæœ‰æ•ˆç±»åï¼‰
      var classes = Array.from(current.classList).filter(function (c) {
        return !c.startsWith('js-');
      });
      var className = classes.length > 0 ? ".".concat(classes[0]) : '';

      // ç”Ÿæˆä½ç½®ç´¢å¼•ï¼ˆnth-childï¼‰
      var tag = current.tagName.toLowerCase();
      if (!className) {
        var siblings = Array.from(current.parentNode.children);
        var index = siblings.findIndex(function (el) {
          return el === current;
        }) + 1;
        selector = "".concat(tag, ":nth-child(").concat(index, ")");
      } else {
        selector = className;
      }
      segments.unshift(selector);
      current = current.parentElement;
    }

    // å¤„ç†æ ¹å…ƒç´ 
    if (current === document.documentElement) {
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  // è·å–å…ƒç´ æ–‡æœ¬å†…å®¹
  function getElementText(element) {
    var _element$textContent;
    if (element.tagName === "INPUT") {
      return element.value || element.placeholder || "";
    }
    if (element.tagName === "TEXTAREA") {
      return element.value || element.placeholder || "";
    }
    var text = ((_element$textContent = element.textContent) === null || _element$textContent === void 0 ? void 0 : _element$textContent.trim()) || "";
    return text.length > 50 ? text.substring(0, 50) + "..." : text;
  }

  // è·å–å…ƒç´ å±æ€§ä¿¡æ¯
  function getElementAttributes(element) {
    var attrs = {};
    for (var i = 0; i < element.attributes.length; i++) {
      var attr = element.attributes[i];
      attrs[attr.name] = attr.value;
    }
    return attrs;
  }

  // é¼ æ ‡æ‚¬åœäº‹ä»¶å¤„ç†
  function handleMouseOver(e) {
    if (!highlightEnabled) return;
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // é¿å…é«˜äº® html å’Œ body å…ƒç´ 
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // å¦‚æœæ˜¯å·²é€‰ä¸­çš„å…ƒç´ ï¼Œä¸æ˜¾ç¤ºæ‚¬åœé«˜äº®
    if (target === selectedElement) {
      highlightBox.style.display = "none";
      tagLabel.style.display = "none";
      return;
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);

    // æ›´æ–°æ‚¬åœé«˜äº®æ¡†ä½ç½®
    highlightBox.style.display = "block";
    highlightBox.style.left = "".concat(rect.left - 2, "px");
    highlightBox.style.top = "".concat(rect.top - 2, "px");
    highlightBox.style.width = "".concat(rect.width + 4, "px");
    highlightBox.style.height = "".concat(rect.height + 4, "px");

    // æ›´æ–°æ ‡ç­¾ä½ç½®å’Œå†…å®¹
    tagLabel.style.display = "block";
    tagLabel.textContent = "<".concat(target.tagName.toLowerCase(), ">");

    // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†çª—
    var labelTop = rect.top - 22;
    var labelLeft = rect.left;

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºé¡¶éƒ¨ï¼Œæ˜¾ç¤ºåœ¨å…ƒç´ ä¸‹æ–¹
    if (labelTop < 0) {
      labelTop = rect.bottom + 5;
    }

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºå³ä¾§ï¼Œå‘å·¦è°ƒæ•´
    if (labelLeft + tagLabel.offsetWidth > window.innerWidth) {
      labelLeft = window.innerWidth - tagLabel.offsetWidth - 5;
    }
    tagLabel.style.left = "".concat(Math.max(0, labelLeft), "px");
    tagLabel.style.top = "".concat(labelTop, "px");

    // å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("æ— æ³•å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
    }
  }

  // é¼ æ ‡ç¦»å¼€äº‹ä»¶å¤„ç†
  function handleMouseOut(e) {
    if (!highlightEnabled) return;
    var relatedTarget = e.relatedTarget;

    // å¦‚æœé¼ æ ‡ç§»åŠ¨åˆ°é«˜äº®ç›¸å…³å…ƒç´ ä¸Šï¼Œä¸éšè—é«˜äº®
    if (relatedTarget && (relatedTarget === highlightBox || relatedTarget === tagLabel || relatedTarget === overlay || relatedTarget === selectedBox || relatedTarget === selectedLabel)) {
      return;
    }
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: null,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("æ— æ³•å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
    }
  }

  // ç‚¹å‡»äº‹ä»¶å¤„ç†
  function handleClick(e) {
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // é¿å…å¤„ç† html å’Œ body å…ƒç´ 
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯äº¤äº’å…ƒç´ ï¼Œè¿™äº›å…ƒç´ éœ€è¦ä¿ç•™é»˜è®¤è¡Œä¸º
    var isInteractiveElement = ['input', 'textarea', 'select', 'button', 'a'].includes(target.tagName.toLowerCase());

    // å¦‚æœé«˜äº®åŠŸèƒ½å¯ç”¨ï¼Œå¯¹äºéäº¤äº’å…ƒç´ é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶ä¼ æ’­
    if (highlightEnabled) {
      e.preventDefault();
      e.stopPropagation();
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);
    console.log("Element clicked:", {
      tagName: target.tagName,
      selector: selector,
      rect: rect
    });

    // ç«‹å³æ›´æ–°é€‰ä¸­é«˜äº®
    updateSelectedHighlight(target);

    // éšè—æ‚¬åœé«˜äº®ï¼Œå› ä¸ºç°åœ¨æ˜¯é€‰ä¸­çŠ¶æ€
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-click",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("æ— æ³•å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
    }
  }

  // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
  function handleParentMessage(event) {
    console.log("Received message from parent:", event.data);
    if (event.data.type === "iframe-highlight-toggle") {
      var enabled = event.data.enabled;
      console.log("Highlight toggle:", enabled);
      if (enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "enable-iframe-highlight") {
      console.log("Enable iframe highlight");
      enableHighlight();
    } else if (event.data.type === "disable-iframe-highlight") {
      console.log("Disable iframe highlight");
      disableHighlight();
    } else if (event.data.type === "toggle-iframe-highlight") {
      var _enabled = event.data.enabled !== undefined ? event.data.enabled : !highlightEnabled;
      console.log("Toggle iframe highlight to:", _enabled);
      if (_enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "update-selected-element") {
      var selector = event.data.selector;
      console.log("Update selected element with selector:", selector);
      if (selector) {
        try {
          var element = document.querySelector(selector);
          console.log("Found element by selector:", element);
          updateSelectedHighlight(element);
        } catch (error) {
          console.warn("Failed to select element:", error);
          updateSelectedHighlight(null);
        }
      } else {
        updateSelectedHighlight(null);
      }
    } else if (event.data.type === "clear-selected-element") {
      console.log("Clear selected element");
      updateSelectedHighlight(null);
    }
  }

  // å¯ç”¨é«˜äº®åŠŸèƒ½
  function enableHighlight() {
    console.log("Enabling highlight");
    document.addEventListener("mouseover", handleMouseOver, true);
    document.addEventListener("mouseout", handleMouseOut, true);
    document.addEventListener("click", handleClick, true);
    highlightEnabled = true;
    overlay.style.display = "block";
  }

  // ç¦ç”¨é«˜äº®åŠŸèƒ½
  function disableHighlight() {
    console.log("Disabling highlight");
    highlightEnabled = false;
    // ä¿æŒäº‹ä»¶ç›‘å¬å™¨ï¼Œä½†é€šè¿‡ highlightEnabled å˜é‡æ§åˆ¶è¡Œä¸º
    // è¿™æ ·å¯ä»¥ä¿ç•™é€‰ä¸­çŠ¶æ€çš„æ˜¾ç¤º
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    // ä¸éšè— selectedBox å’Œ selectedLabelï¼Œä¿ç•™é€‰ä¸­çŠ¶æ€
  }

  // å®Œå…¨ç¦ç”¨é«˜äº®åŠŸèƒ½ï¼ˆç§»é™¤æ‰€æœ‰ç›‘å¬å™¨ï¼‰
  function fullyDisableHighlight() {
    console.log("Fully disabling highlight");
    highlightEnabled = false;
    document.removeEventListener("mouseover", handleMouseOver, true);
    document.removeEventListener("mouseout", handleMouseOut, true);
    document.removeEventListener("click", handleClick, true);
    overlay.style.display = "none";
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    selectedBox.style.display = "none";
    selectedLabel.style.display = "none";
  }

  // æ·»åŠ äº‹ä»¶ç›‘å¬
  enableHighlight();
  window.addEventListener("message", handleParentMessage);

  // æš´éœ²å…¨å±€å‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨
  window.__iframeHighlightControl = {
    enable: enableHighlight,
    disable: disableHighlight,
    fullyDisable: fullyDisableHighlight,
    isEnabled: function isEnabled() {
      return highlightEnabled;
    },
    getSelectedElement: function getSelectedElement() {
      return selectedElement;
    },
    updateSelected: updateSelectedHighlight,
    // é€šè¿‡æ¶ˆæ¯å‘é€å¼€å…³æ§åˆ¶
    sendToggleMessage: function sendToggleMessage(enabled) {
      window.parent.postMessage({
        type: 'iframe-highlight-status',
        enabled: enabled || highlightEnabled,
        source: 'iframe-highlight-injector'
      }, '*');
    }
  };

  // é€šçŸ¥çˆ¶çª—å£è„šæœ¬å·²åŠ è½½
  try {
    window.parent.postMessage({
      type: "iframe-highlight-ready",
      data: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
      },
      source: "iframe-highlight-injector"
    }, "*");
  } catch (error) {
    console.warn("æ— æ³•å‘é€å°±ç»ªæ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
  }

  // æ¸…ç†å‡½æ•°
  window.__iframeHighlightCleanup = function () {
    fullyDisableHighlight();
    window.removeEventListener("message", handleParentMessage);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
    delete window.__iframeHighlightInitialized;
    delete window.__iframeHighlightCleanup;
  };
})();

</script>

<script>
/**
 * Iframe å…ƒç´ é«˜äº®æ³¨å…¥è„šæœ¬
 * éœ€è¦åœ¨ç›®æ ‡ç½‘ç«™ä¸­å¼•å…¥æ­¤è„šæœ¬æ¥æ”¯æŒè·¨åŸŸ iframe é«˜äº®åŠŸèƒ½
 *
 * ä½¿ç”¨æ–¹æ³•ï¼š
 * 1. å°†æ­¤è„šæœ¬æ·»åŠ åˆ°ç›®æ ‡ç½‘ç«™çš„ HTML ä¸­
 * 2. æˆ–é€šè¿‡æµè§ˆå™¨æ‰©å±•ã€ç”¨æˆ·è„šæœ¬ç­‰æ–¹å¼æ³¨å…¥
 */

(function () {
  "use strict";

  // æ£€æŸ¥æ˜¯å¦åœ¨ iframe ä¸­
  if (window.self === window.top) {
    return; // ä¸åœ¨ iframe ä¸­ï¼Œä¸æ‰§è¡Œ
  }

  // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
  if (window.__iframeHighlightInitialized) {
    return;
  }
  window.__iframeHighlightInitialized = true;
  console.log("Iframe é«˜äº®è„šæœ¬å·²åŠ è½½");

  // åˆ›å»ºé«˜äº®è¦†ç›–å±‚
  var overlay = document.createElement("div");
  overlay.id = "iframe-highlight-overlay";
  overlay.style.cssText = "\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    pointer-events: none;\n    z-index: 999999;\n    overflow: hidden;\n  ";

  // åˆ›å»ºæ‚¬åœé«˜äº®æ¡†ï¼ˆè™šçº¿è¾¹æ¡†ï¼‰
  var highlightBox = document.createElement("div");
  highlightBox.id = "iframe-highlight-box";
  highlightBox.style.cssText = "\n    position: absolute;\n    border: 2px dashed #007AFF;\n    background: rgba(0, 122, 255, 0.08);\n    pointer-events: none;\n    display: none;\n    transition: all 0.1s ease;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8);\n    border-radius: 2px;\n  ";

  // åˆ›å»ºé€‰ä¸­èŠ‚ç‚¹çš„å¸¸é©»é«˜äº®æ¡†ï¼ˆå®çº¿è¾¹æ¡†ï¼‰
  var selectedBox = document.createElement("div");
  selectedBox.id = "iframe-selected-box";
  selectedBox.style.cssText = "\n    position: absolute;\n    border: 2px solid #007AFF;\n    pointer-events: none;\n    display: none;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 107, 53, 0.4);\n    border-radius: 2px;\n    z-index: 1000000;\n  ";

  // åˆ›å»ºæ‚¬åœæ ‡ç­¾æ˜¾ç¤º
  var tagLabel = document.createElement("div");
  tagLabel.id = "iframe-tag-label";
  tagLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 2px 6px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 2px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000001;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n    font-weight: 500;\n  ";

  // åˆ›å»ºé€‰ä¸­èŠ‚ç‚¹æ ‡ç­¾
  var selectedLabel = document.createElement("div");
  selectedLabel.id = "iframe-selected-label";
  selectedLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 3px 8px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 3px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000002;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);\n    font-weight: 600;\n  ";
  overlay.appendChild(highlightBox);
  overlay.appendChild(selectedBox);
  overlay.appendChild(tagLabel);
  overlay.appendChild(selectedLabel);
  document.body.appendChild(overlay);

  // å­˜å‚¨å½“å‰é€‰ä¸­çš„å…ƒç´ 
  var selectedElement = null;
  var highlightEnabled = false;

  // æ›´æ–°é€‰ä¸­å…ƒç´ çš„é«˜äº®æ˜¾ç¤º
  function updateSelectedHighlight(element) {
    console.log("updateSelectedHighlight called with:", element);
    if (!element) {
      selectedBox.style.display = "none";
      selectedLabel.style.display = "none";
      selectedElement = null;
      console.log("Cleared selected highlight");
      return;
    }
    selectedElement = element;
    var rect = element.getBoundingClientRect();
    console.log("Selected element rect:", rect);

    // æ›´æ–°é€‰ä¸­é«˜äº®æ¡†ä½ç½®
    selectedBox.style.display = "block";
    selectedBox.style.left = "".concat(rect.left - 2, "px");
    selectedBox.style.top = "".concat(rect.top - 2, "px");
    selectedBox.style.width = "".concat(rect.width + 4, "px");
    selectedBox.style.height = "".concat(rect.height + 4, "px");

    // æ›´æ–°é€‰ä¸­æ ‡ç­¾ä½ç½®å’Œå†…å®¹
    selectedLabel.style.display = "block";
    selectedLabel.textContent = "\u2713 <".concat(element.tagName.toLowerCase(), ">");

    // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†çª—
    var labelTop = rect.top - 28;
    var labelLeft = rect.left;

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºé¡¶éƒ¨ï¼Œæ˜¾ç¤ºåœ¨å…ƒç´ ä¸‹æ–¹
    if (labelTop < 5) {
      labelTop = rect.bottom + 5;
    }

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºå³ä¾§ï¼Œå‘å·¦è°ƒæ•´
    var labelWidth = selectedLabel.offsetWidth || 100; // é¢„ä¼°å®½åº¦
    if (labelLeft + labelWidth > window.innerWidth - 10) {
      labelLeft = window.innerWidth - labelWidth - 10;
    }
    selectedLabel.style.left = "".concat(Math.max(5, labelLeft), "px");
    selectedLabel.style.top = "".concat(labelTop, "px");
    console.log("Selected highlight positioned at:", {
      left: selectedBox.style.left,
      top: selectedBox.style.top,
      width: selectedBox.style.width,
      height: selectedBox.style.height
    });
  }
  function getElementSelector(element) {
    if (!(element instanceof Element)) throw new Error('Argument must be a DOM element');
    var segments = [];
    var current = element;
    while (current !== document.documentElement) {
      var selector = '';
      // ä¼˜å…ˆæ£€æŸ¥å”¯ä¸€ID
      if (current.id && document.querySelectorAll("#".concat(current.id)).length === 1) {
        segments.unshift("#".concat(current.id));
        break; // IDå”¯ä¸€ï¼Œæ— éœ€ç»§ç»­å‘ä¸Š
      }

      // ç”Ÿæˆç±»åé€‰æ‹©å™¨ï¼ˆå–ç¬¬ä¸€ä¸ªæœ‰æ•ˆç±»åï¼‰
      var classes = Array.from(current.classList).filter(function (c) {
        return !c.startsWith('js-');
      });
      var className = classes.length > 0 ? ".".concat(classes[0]) : '';

      // ç”Ÿæˆä½ç½®ç´¢å¼•ï¼ˆnth-childï¼‰
      var tag = current.tagName.toLowerCase();
      if (!className) {
        var siblings = Array.from(current.parentNode.children);
        var index = siblings.findIndex(function (el) {
          return el === current;
        }) + 1;
        selector = "".concat(tag, ":nth-child(").concat(index, ")");
      } else {
        selector = className;
      }
      segments.unshift(selector);
      current = current.parentElement;
    }

    // å¤„ç†æ ¹å…ƒç´ 
    if (current === document.documentElement) {
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  // è·å–å…ƒç´ æ–‡æœ¬å†…å®¹
  function getElementText(element) {
    var _element$textContent;
    if (element.tagName === "INPUT") {
      return element.value || element.placeholder || "";
    }
    if (element.tagName === "TEXTAREA") {
      return element.value || element.placeholder || "";
    }
    var text = ((_element$textContent = element.textContent) === null || _element$textContent === void 0 ? void 0 : _element$textContent.trim()) || "";
    return text.length > 50 ? text.substring(0, 50) + "..." : text;
  }

  // è·å–å…ƒç´ å±æ€§ä¿¡æ¯
  function getElementAttributes(element) {
    var attrs = {};
    for (var i = 0; i < element.attributes.length; i++) {
      var attr = element.attributes[i];
      attrs[attr.name] = attr.value;
    }
    return attrs;
  }

  // é¼ æ ‡æ‚¬åœäº‹ä»¶å¤„ç†
  function handleMouseOver(e) {
    if (!highlightEnabled) return;
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // é¿å…é«˜äº® html å’Œ body å…ƒç´ 
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // å¦‚æœæ˜¯å·²é€‰ä¸­çš„å…ƒç´ ï¼Œä¸æ˜¾ç¤ºæ‚¬åœé«˜äº®
    if (target === selectedElement) {
      highlightBox.style.display = "none";
      tagLabel.style.display = "none";
      return;
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);

    // æ›´æ–°æ‚¬åœé«˜äº®æ¡†ä½ç½®
    highlightBox.style.display = "block";
    highlightBox.style.left = "".concat(rect.left - 2, "px");
    highlightBox.style.top = "".concat(rect.top - 2, "px");
    highlightBox.style.width = "".concat(rect.width + 4, "px");
    highlightBox.style.height = "".concat(rect.height + 4, "px");

    // æ›´æ–°æ ‡ç­¾ä½ç½®å’Œå†…å®¹
    tagLabel.style.display = "block";
    tagLabel.textContent = "<".concat(target.tagName.toLowerCase(), ">");

    // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†çª—
    var labelTop = rect.top - 22;
    var labelLeft = rect.left;

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºé¡¶éƒ¨ï¼Œæ˜¾ç¤ºåœ¨å…ƒç´ ä¸‹æ–¹
    if (labelTop < 0) {
      labelTop = rect.bottom + 5;
    }

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºå³ä¾§ï¼Œå‘å·¦è°ƒæ•´
    if (labelLeft + tagLabel.offsetWidth > window.innerWidth) {
      labelLeft = window.innerWidth - tagLabel.offsetWidth - 5;
    }
    tagLabel.style.left = "".concat(Math.max(0, labelLeft), "px");
    tagLabel.style.top = "".concat(labelTop, "px");

    // å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("æ— æ³•å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
    }
  }

  // é¼ æ ‡ç¦»å¼€äº‹ä»¶å¤„ç†
  function handleMouseOut(e) {
    if (!highlightEnabled) return;
    var relatedTarget = e.relatedTarget;

    // å¦‚æœé¼ æ ‡ç§»åŠ¨åˆ°é«˜äº®ç›¸å…³å…ƒç´ ä¸Šï¼Œä¸éšè—é«˜äº®
    if (relatedTarget && (relatedTarget === highlightBox || relatedTarget === tagLabel || relatedTarget === overlay || relatedTarget === selectedBox || relatedTarget === selectedLabel)) {
      return;
    }
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: null,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("æ— æ³•å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
    }
  }

  // ç‚¹å‡»äº‹ä»¶å¤„ç†
  function handleClick(e) {
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // é¿å…å¤„ç† html å’Œ body å…ƒç´ 
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯äº¤äº’å…ƒç´ ï¼Œè¿™äº›å…ƒç´ éœ€è¦ä¿ç•™é»˜è®¤è¡Œä¸º
    var isInteractiveElement = ['input', 'textarea', 'select', 'button', 'a'].includes(target.tagName.toLowerCase());

    // å¦‚æœé«˜äº®åŠŸèƒ½å¯ç”¨ï¼Œå¯¹äºéäº¤äº’å…ƒç´ é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶ä¼ æ’­
    if (highlightEnabled) {
      e.preventDefault();
      e.stopPropagation();
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);
    console.log("Element clicked:", {
      tagName: target.tagName,
      selector: selector,
      rect: rect
    });

    // ç«‹å³æ›´æ–°é€‰ä¸­é«˜äº®
    updateSelectedHighlight(target);

    // éšè—æ‚¬åœé«˜äº®ï¼Œå› ä¸ºç°åœ¨æ˜¯é€‰ä¸­çŠ¶æ€
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-click",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("æ— æ³•å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
    }
  }

  // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
  function handleParentMessage(event) {
    console.log("Received message from parent:", event.data);
    if (event.data.type === "iframe-highlight-toggle") {
      var enabled = event.data.enabled;
      console.log("Highlight toggle:", enabled);
      if (enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "enable-iframe-highlight") {
      console.log("Enable iframe highlight");
      enableHighlight();
    } else if (event.data.type === "disable-iframe-highlight") {
      console.log("Disable iframe highlight");
      disableHighlight();
    } else if (event.data.type === "toggle-iframe-highlight") {
      var _enabled = event.data.enabled !== undefined ? event.data.enabled : !highlightEnabled;
      console.log("Toggle iframe highlight to:", _enabled);
      if (_enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "update-selected-element") {
      var selector = event.data.selector;
      console.log("Update selected element with selector:", selector);
      if (selector) {
        try {
          var element = document.querySelector(selector);
          console.log("Found element by selector:", element);
          updateSelectedHighlight(element);
        } catch (error) {
          console.warn("Failed to select element:", error);
          updateSelectedHighlight(null);
        }
      } else {
        updateSelectedHighlight(null);
      }
    } else if (event.data.type === "clear-selected-element") {
      console.log("Clear selected element");
      updateSelectedHighlight(null);
    }
  }

  // å¯ç”¨é«˜äº®åŠŸèƒ½
  function enableHighlight() {
    console.log("Enabling highlight");
    document.addEventListener("mouseover", handleMouseOver, true);
    document.addEventListener("mouseout", handleMouseOut, true);
    document.addEventListener("click", handleClick, true);
    highlightEnabled = true;
    overlay.style.display = "block";
  }

  // ç¦ç”¨é«˜äº®åŠŸèƒ½
  function disableHighlight() {
    console.log("Disabling highlight");
    highlightEnabled = false;
    // ä¿æŒäº‹ä»¶ç›‘å¬å™¨ï¼Œä½†é€šè¿‡ highlightEnabled å˜é‡æ§åˆ¶è¡Œä¸º
    // è¿™æ ·å¯ä»¥ä¿ç•™é€‰ä¸­çŠ¶æ€çš„æ˜¾ç¤º
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    // ä¸éšè— selectedBox å’Œ selectedLabelï¼Œä¿ç•™é€‰ä¸­çŠ¶æ€
  }

  // å®Œå…¨ç¦ç”¨é«˜äº®åŠŸèƒ½ï¼ˆç§»é™¤æ‰€æœ‰ç›‘å¬å™¨ï¼‰
  function fullyDisableHighlight() {
    console.log("Fully disabling highlight");
    highlightEnabled = false;
    document.removeEventListener("mouseover", handleMouseOver, true);
    document.removeEventListener("mouseout", handleMouseOut, true);
    document.removeEventListener("click", handleClick, true);
    overlay.style.display = "none";
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    selectedBox.style.display = "none";
    selectedLabel.style.display = "none";
  }

  // æ·»åŠ äº‹ä»¶ç›‘å¬
  enableHighlight();
  window.addEventListener("message", handleParentMessage);

  // æš´éœ²å…¨å±€å‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨
  window.__iframeHighlightControl = {
    enable: enableHighlight,
    disable: disableHighlight,
    fullyDisable: fullyDisableHighlight,
    isEnabled: function isEnabled() {
      return highlightEnabled;
    },
    getSelectedElement: function getSelectedElement() {
      return selectedElement;
    },
    updateSelected: updateSelectedHighlight,
    // é€šè¿‡æ¶ˆæ¯å‘é€å¼€å…³æ§åˆ¶
    sendToggleMessage: function sendToggleMessage(enabled) {
      window.parent.postMessage({
        type: 'iframe-highlight-status',
        enabled: enabled || highlightEnabled,
        source: 'iframe-highlight-injector'
      }, '*');
    }
  };

  // é€šçŸ¥çˆ¶çª—å£è„šæœ¬å·²åŠ è½½
  try {
    window.parent.postMessage({
      type: "iframe-highlight-ready",
      data: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
      },
      source: "iframe-highlight-injector"
    }, "*");
  } catch (error) {
    console.warn("æ— æ³•å‘é€å°±ç»ªæ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
  }

  // æ¸…ç†å‡½æ•°
  window.__iframeHighlightCleanup = function () {
    fullyDisableHighlight();
    window.removeEventListener("message", handleParentMessage);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
    delete window.__iframeHighlightInitialized;
    delete window.__iframeHighlightCleanup;
  };
})();

</script>
<script src="js/progression.js"></script>
</body>
</html>
